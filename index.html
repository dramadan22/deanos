<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeanOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-warm: #FAF7F2;
            --bg-card: #FFFFFF;
            --bg-input: #F5F1EA;
            --bg-hover: #F0EBE3;
            --text-primary: #2C2C2C;
            --text-secondary: #6B6358;
            --text-muted: #9B9286;
            --border: #E5DED3;
            --border-light: #EDE8E0;
            --forest: #2D5A3D;
            --forest-light: #3D7A52;
            --forest-bg: #E8F0EA;
            --brown: #8B6F47;
            --brown-light: #A6895E;
            --amber: #D4A84B;
            --amber-light: #F0D78A;
            --red-soft: #C75D5D;
            --red-bg: #FCEAEA;
            --blue-soft: #5D8AC7;
            --purple-soft: #8B5DC7;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.1);
            --shadow-card: 0 2px 8px rgba(0,0,0,0.04);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.2s ease;
            --transition-slow: 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, sans-serif;
            background: var(--bg-warm);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        h1, h2, h3, h4 {
            font-family: 'Merriweather', Georgia, serif;
            font-weight: 700;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            padding: 0.875rem 2rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 1px 0 rgba(0,0,0,0.02);
            backdrop-filter: blur(8px);
            background: rgba(255,255,255,0.95);
        }

        .logo {
            font-family: 'Merriweather', serif;
            font-size: 1.4rem;
            color: var(--forest);
            letter-spacing: -0.02em;
            user-select: none;
        }

        .logo span {
            color: var(--brown);
        }

        .header-stats {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .stat-badge {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.4rem 0.8rem;
            background: var(--bg-input);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .streak-badge {
            background: var(--amber-light);
            color: var(--brown);
            font-weight: 600;
        }

        .level-badge {
            background: var(--forest);
            color: white;
            font-weight: 600;
        }

        .xp-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .xp-bar {
            width: 120px;
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--forest), var(--forest-light));
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Main Layout */
        .main-container {
            display: flex;
            min-height: calc(100vh - 56px);
        }

        .sidebar {
            width: 240px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-light);
            padding: 1.25rem 0;
            position: sticky;
            top: 56px;
            height: calc(100vh - 56px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            margin-bottom: 1.25rem;
        }

        .sidebar-section:last-child {
            margin-top: auto;
            margin-bottom: 0;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .sidebar-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            padding: 0 1.25rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .sidebar-btn {
            width: 100%;
            background: none;
            border: none;
            color: var(--text-secondary);
            padding: 0.625rem 1.25rem;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transition: all var(--transition-fast);
            font-family: inherit;
            border-radius: 0;
            position: relative;
        }

        .sidebar-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sidebar-btn.active {
            background: var(--forest-bg);
            color: var(--forest);
            font-weight: 600;
        }

        .sidebar-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--forest);
            border-radius: 0 2px 2px 0;
        }

        .sidebar-icon {
            font-size: 1.1rem;
            width: 22px;
            text-align: center;
            opacity: 0.85;
        }

        .sidebar-btn.active .sidebar-icon {
            opacity: 1;
        }

        .content-area {
            flex: 1;
            padding: 2rem 2.5rem;
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-card);
            margin-bottom: 1.25rem;
            transition: box-shadow var(--transition-normal), transform var(--transition-normal);
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        .card-body {
            padding: 1.25rem;
        }

        /* Morning Dashboard */
        .greeting {
            font-family: 'Merriweather', serif;
            font-size: 1.75rem;
            color: var(--forest);
            margin-bottom: 0.35rem;
            letter-spacing: -0.02em;
        }

        .date-display {
            color: var(--text-secondary);
            margin-bottom: 1.75rem;
            font-size: 0.95rem;
        }

        .quick-log-bar {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.75rem;
        }

        .quick-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            font-family: inherit;
            font-weight: 500;
        }

        .quick-btn:hover {
            background: var(--forest-bg);
            border-color: var(--forest);
            color: var(--forest);
            transform: translateY(-1px);
        }

        .quick-btn.logged {
            background: var(--forest);
            color: white;
            border-color: var(--forest);
            box-shadow: 0 2px 8px rgba(45, 90, 61, 0.25);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
        }

        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hydration Tracker */
        .hydration-display {
            text-align: center;
            padding: 1rem 0;
        }

        .hydration-count {
            font-size: 3rem;
            font-weight: 700;
            color: var(--forest);
            font-family: 'Merriweather', serif;
        }

        .hydration-goal {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .hydration-bar {
            height: 12px;
            background: var(--bg-input);
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .hydration-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--blue-soft), var(--forest));
            transition: width 0.3s;
        }

        .hydration-slider {
            margin: 0.75rem 0 1rem;
        }

        .hydration-slider input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        .hydration-scale {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.4rem;
        }

        .hydration-btns {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .hydration-btn {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: inherit;
        }

        .hydration-btn:hover {
            background: var(--forest-bg);
        }

        .is-hidden {
            display: none;
        }

        .workout-day-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .workout-day-type-card {
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .workout-day-type-card select {
            flex: 1;
        }

        #weeklyMealPlan.mealplan-refresh {
            animation: mealPlanFade 0.45s ease;
        }

        @keyframes mealPlanFade {
            from { opacity: 0.25; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .research-feed-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .research-feed-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .research-feed-item:last-child {
            border-bottom: none;
        }

        .research-feed-title a {
            color: var(--forest);
            text-decoration: none;
            font-weight: 600;
        }

        .research-feed-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* POTS Research Library Styles */
        .pots-research-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .pots-category-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .pots-category-tab {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--bg-input);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.15s;
        }

        .pots-category-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .pots-category-tab.active {
            background: var(--forest);
            color: white;
            border-color: var(--forest);
        }

        .pots-research-item {
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            padding: 1rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .pots-research-item:hover {
            background: var(--bg-hover);
        }

        .pots-research-item.expanded {
            background: var(--forest-bg);
        }

        .pots-research-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .pots-research-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .pots-research-source {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .pots-research-expand {
            color: var(--text-muted);
            font-size: 1.2rem;
            transition: transform 0.2s;
        }

        .pots-research-item.expanded .pots-research-expand {
            transform: rotate(180deg);
        }

        .pots-research-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 0.5rem;
            line-height: 1.5;
        }

        .pots-research-details {
            display: none;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .pots-research-item.expanded .pots-research-details {
            display: block;
        }

        .pots-key-points {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .pots-key-points li {
            padding: 0.4rem 0;
            padding-left: 1.25rem;
            position: relative;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .pots-key-points li::before {
            content: "â€¢";
            position: absolute;
            left: 0;
            color: var(--forest);
            font-weight: bold;
        }

        .pots-research-link {
            display: inline-block;
            margin-top: 0.75rem;
            color: var(--forest);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .pots-research-link:hover {
            text-decoration: underline;
        }

        .pots-category-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .auto-feed-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Priority Tasks */
        .priority-section {
            margin-bottom: 1rem;
        }

        .priority-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .priority-high .priority-dot { background: var(--red-soft); }
        .priority-medium .priority-dot { background: var(--amber); }
        .priority-low .priority-dot { background: var(--forest); }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            margin-bottom: 0.5rem;
            border: 1px solid transparent;
            transition: all 0.15s;
        }

        .task-item:hover {
            background: var(--bg-hover);
            border-color: var(--border);
        }

        .task-item.completed {
            opacity: 0.5;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
        }

        .task-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.15s;
        }

        .task-checkbox:hover {
            border-color: var(--forest);
        }

        .task-checkbox.checked {
            background: var(--forest);
            border-color: var(--forest);
            color: white;
        }

        .task-text {
            flex: 1;
            font-size: 0.95rem;
        }

        .task-xp {
            font-size: 0.75rem;
            color: var(--amber);
            font-weight: 600;
        }

        .task-delete {
            opacity: 0;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.25rem;
        }

        .task-item:hover .task-delete {
            opacity: 1;
        }

        .task-delete:hover {
            color: var(--red-soft);
        }

        /* Symptoms Quick Log */
        .symptom-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .symptom-btn {
            padding: 0.6rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.15s;
            font-family: inherit;
        }

        .symptom-btn:hover {
            border-color: var(--red-soft);
            background: var(--red-bg);
        }

        .symptom-btn.active {
            background: var(--red-bg);
            border-color: var(--red-soft);
            color: var(--red-soft);
        }

        /* Module Views */
        .module-view {
            display: none;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .module-view.active {
            display: block;
        }

        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.75rem;
        }

        .view-title {
            font-size: 1.4rem;
            color: var(--forest);
            letter-spacing: -0.02em;
        }

        /* Forms & Inputs */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.95rem;
            font-family: inherit;
            background: var(--bg-input);
            transition: all var(--transition-fast);
        }

        .input-field:hover {
            border-color: var(--text-muted);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--forest);
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1);
        }

        textarea.input-field {
            resize: vertical;
            min-height: 100px;
            line-height: 1.6;
        }

        select.input-field {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236B6358' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--forest);
            color: white;
            box-shadow: 0 1px 3px rgba(45, 90, 61, 0.2);
        }

        .btn-primary:hover {
            background: var(--forest-light);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 61, 0.25);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }

        .btn-small {
            padding: 0.5rem 0.875rem;
            font-size: 0.8rem;
        }

        .btn-icon {
            padding: 0.5rem;
            min-width: 36px;
            min-height: 36px;
        }

        /* Consumption Tracker */
        .consumption-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .consumption-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            font-family: inherit;
        }

        .consumption-tab.active {
            background: var(--forest-bg);
            color: var(--forest);
            font-weight: 600;
        }

        .consumption-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-input);
            border-radius: var(--radius);
            margin-bottom: 1rem;
            align-items: flex-start;
        }

        .consumption-poster {
            width: 80px;
            height: 100px;
            background: var(--bg-hover);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            flex-shrink: 0;
        }

        .consumption-info {
            flex: 1;
        }

        .consumption-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .consumption-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .consumption-notes {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Watchlist */
        .watchlist-source-badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 4px;
            background: var(--forest-bg);
            color: var(--forest);
            font-weight: 600;
            white-space: nowrap;
        }

        .watchlist-item-actions {
            display: flex;
            gap: 0.25rem;
            align-items: center;
            flex-shrink: 0;
        }

        .tier-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.85rem;
        }

        .tier-S { background: #FFD700; color: #5C4A00; }
        .tier-A { background: #90EE90; color: #1B5E20; }
        .tier-B { background: #87CEEB; color: #0D47A1; }
        .tier-C { background: #DDA0DD; color: #4A148C; }
        .tier-F { background: #FFB6B6; color: #8B0000; }

        /* Tier Selector */
        .tier-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tier-option {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 700;
            transition: all 0.15s;
        }

        .tier-option:hover, .tier-option.selected {
            transform: scale(1.05);
        }

        .tier-option.selected {
            border-color: currentColor;
        }

        .tier-option[data-tier="S"] { color: #B8860B; }
        .tier-option[data-tier="A"] { color: #228B22; }
        .tier-option[data-tier="B"] { color: #4169E1; }
        .tier-option[data-tier="C"] { color: #8B008B; }
        .tier-option[data-tier="F"] { color: #B22222; }

        /* Notes */
        .notes-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .notes-sidebar {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            padding: 1rem;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
            position: sticky;
            top: 80px;
        }

        .note-card {
            padding: 0.875rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-bottom: 0.5rem;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
        }

        .note-card:hover {
            background: var(--bg-hover);
            border-color: var(--border);
        }

        .note-card.active {
            background: var(--forest-bg);
            border-color: var(--forest);
        }

        .note-card-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-card-date {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .note-card-preview {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 0.35rem;
        }

        .notes-editor {
            background: var(--bg-card);
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            padding: 1.5rem;
        }

        .notes-textarea {
            width: 100%;
            min-height: 450px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-input);
            font-family: 'Source Sans Pro', -apple-system, sans-serif;
            font-size: 0.95rem;
            line-height: 1.7;
            resize: vertical;
            color: var(--text-primary);
            padding: 1.25rem;
            transition: all var(--transition-fast);
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--forest);
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1);
        }

        .mood-btn {
            font-size: 1.5rem;
            padding: 0.5rem;
            border: 2px solid transparent;
            background: var(--bg-input);
            border-radius: var(--radius-sm);
            cursor: pointer;
            opacity: 0.5;
            transition: all 0.15s;
        }

        .mood-btn:hover, .mood-btn.selected {
            opacity: 1;
            border-color: var(--forest);
            background: var(--forest-bg);
        }

        /* Insights Panel */
        .insight-card {
            background: linear-gradient(135deg, var(--forest-bg), var(--bg-card));
            border: 1px solid var(--forest);
            border-radius: var(--radius);
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .insight-icon {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .insight-text {
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        .insight-data {
            font-weight: 600;
            color: var(--forest);
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .achievement-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.25rem;
            text-align: center;
            opacity: 0.4;
            transition: all 0.2s;
        }

        .achievement-card.unlocked {
            opacity: 1;
            border-color: var(--amber);
            background: linear-gradient(180deg, var(--bg-card), #FFFBF0);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .achievement-name {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }

        .achievement-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .achievement-progress {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.15s ease;
        }

        .modal {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 1.75rem;
            max-width: 480px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideUp 0.2s ease;
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-title {
            font-size: 1.2rem;
            margin-bottom: 1.25rem;
            color: var(--forest);
            letter-spacing: -0.02em;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.25rem;
            border-top: 1px solid var(--border-light);
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .form-row {
            display: flex;
            gap: 1rem;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            font-weight: 600;
            animation: slideIn 0.3s ease;
            z-index: 1000;
            box-shadow: var(--shadow-md);
        }

        .notification.xp {
            background: var(--forest);
            color: white;
        }

        .notification.level-up {
            background: linear-gradient(135deg, var(--amber), var(--amber-light));
            color: var(--brown);
            font-size: 1.1rem;
        }

        .notification.success {
            background: var(--forest-bg);
            color: var(--forest);
            border: 1px solid var(--forest);
        }

        .notification.streak {
            background: var(--amber-light);
            color: var(--brown);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Health Charts Placeholder */
        .chart-placeholder {
            background: var(--bg-input);
            border-radius: var(--radius);
            padding: 2rem;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Progress Ring */
        .progress-ring {
            width: 80px;
            height: 80px;
            margin: 0 auto;
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 6;
        }

        .progress-ring .bg {
            stroke: var(--bg-input);
        }

        .progress-ring .progress {
            stroke: var(--forest);
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: var(--bg-input);
            border-radius: var(--radius);
            padding: 1rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--forest);
            font-family: 'Merriweather', serif;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-warm);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            background: var(--forest-bg);
            color: var(--forest);
            border-radius: 4px;
            font-size: 0.75rem;
            margin-right: 0.25rem;
        }

        /* Research */
        .note-card {
            background: var(--bg-input);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .note-content {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        /* Health Metrics Log */
        .metric-log-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-log-item:last-child {
            border-bottom: none;
        }

        /* Oura Data Rows */
        .oura-day-row {
            cursor: pointer;
            transition: background 0.15s;
        }

        .oura-day-row:hover {
            background: var(--bg-hover);
        }

        /* Bad Behavior Buttons */
        .behavior-bad {
            background: var(--bg-card);
            border-color: var(--border);
        }

        .behavior-bad.triggered {
            background: var(--red-bg);
            border-color: var(--red-soft);
            color: var(--red-soft);
        }

        .behavior-bad:hover:not(.triggered) {
            border-color: var(--red-soft);
            background: var(--red-bg);
        }

        /* Workout Day Selector */
        .workout-day-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .workout-day-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.15s;
            font-family: inherit;
        }

        .workout-day-btn:hover {
            border-color: var(--forest);
            background: var(--forest-bg);
        }

        .workout-day-btn.selected {
            background: var(--forest);
            color: white;
            border-color: var(--forest);
        }

        /* ==================== WEEKLY PLANNER ==================== */

        .planner-week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.75rem;
        }

        @media (max-width: 1200px) {
            .planner-week-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 768px) {
            .planner-week-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .planner-week-grid {
                grid-template-columns: 1fr;
            }
        }

        .planner-day-card {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all var(--transition-fast);
            overflow: hidden;
        }

        .planner-day-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--forest);
        }

        .planner-day-today {
            border-color: var(--forest);
            border-width: 2px;
        }

        .planner-day-card-header {
            background: var(--forest-bg);
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .planner-day-today .planner-day-card-header {
            background: var(--forest);
            color: white;
        }

        .planner-day-today .planner-day-name {
            color: white;
        }

        .planner-day-today .planner-day-progress {
            color: rgba(255,255,255,0.8);
        }

        .planner-day-name {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--forest);
        }

        .planner-day-progress {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .planner-day-card-body {
            padding: 0.5rem 0.75rem;
        }

        .planner-mini-item {
            font-size: 0.78rem;
            padding: 0.15rem 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .planner-mini-item.done {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .planner-mini-item.empty {
            color: var(--text-muted);
        }

        .planner-mini-empty {
            color: var(--border);
        }

        .planner-day-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.25rem;
        }

        .planner-day-btn {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
            text-align: center;
        }

        .planner-day-btn:hover {
            background: var(--forest-bg);
            border-color: var(--forest);
            color: var(--forest);
        }

        .planner-day-btn.active {
            background: var(--forest);
            color: white;
            border-color: var(--forest);
        }

        .planner-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .planner-item:last-child {
            border-bottom: none;
        }

        .planner-item.completed {
            opacity: 0.6;
        }

        .planner-item.completed .planner-inline-input {
            text-decoration: line-through;
        }

        .planner-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .planner-item-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .planner-inline-input {
            width: 100%;
            padding: 0.4rem 0.6rem;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-family: inherit;
            background: transparent;
            transition: all var(--transition-fast);
        }

        .planner-inline-input:hover {
            background: var(--bg-input);
            border-color: var(--border);
        }

        .planner-inline-input:focus {
            outline: none;
            border-color: var(--forest);
            background: white;
            box-shadow: 0 0 0 3px rgba(45, 90, 61, 0.1);
        }

        .planner-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .planner-nav-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-card);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .planner-nav-btn:hover {
            background: var(--forest-bg);
            border-color: var(--forest);
            color: var(--forest);
        }

        .planner-week-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-right: 0.5rem;
        }

        /* Tasks Complete Animation */
        .tasks-complete-animation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .confetti-container {
            text-align: center;
            animation: bounceIn 0.5s ease;
        }

        .celebration-text {
            font-size: 2rem;
            font-family: 'Merriweather', serif;
            color: white;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Year Item */
        .year-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .year-item:last-child {
            border-bottom: none;
        }

        .year-item-title {
            font-weight: 500;
        }

        .year-item-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Lock Screen */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-warm);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .lock-container {
            text-align: center;
            padding: 2rem;
        }

        .lock-logo {
            font-family: 'Merriweather', serif;
            font-size: 2.5rem;
            color: var(--forest);
            margin-bottom: 1rem;
        }

        .lock-logo span {
            color: var(--brown);
        }

        /* Sync Status Button */
        .sync-status-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.4rem 0.6rem;
            border-radius: 20px;
            font-size: 1.1rem;
            transition: background 0.15s;
        }

        .sync-status-btn:hover {
            background: var(--bg-hover);
        }

        .sync-icon {
            display: inline-block;
        }

        .sync-icon.synced {
            color: var(--forest);
        }

        .sync-icon.warning {
            color: var(--amber);
        }

        .sync-icon.error {
            color: var(--red-soft);
        }

        .sync-icon.syncing {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Sync Modal */
        .sync-modal {
            display: none;
            position: fixed;
            top: 60px;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            padding: 1rem;
            z-index: 1001;
            width: 280px;
            max-width: calc(100vw - 2rem);
        }

        .sync-modal.active {
            display: block;
        }

        .sync-modal-header {
            font-weight: 600;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .sync-modal-status {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .sync-modal-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .sync-modal-buttons .btn {
            flex: 1;
            font-size: 0.85rem;
            padding: 0.5rem;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            flex-direction: column;
            justify-content: center;
            gap: 5px;
            width: 32px;
            height: 32px;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
        }

        .mobile-menu-btn span {
            display: block;
            width: 100%;
            height: 2px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn.active span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }

        .mobile-menu-btn.active span:nth-child(2) {
            opacity: 0;
        }

        .mobile-menu-btn.active span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }

            .header {
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }

            .header-stats {
                display: none;
            }

            .logo {
                font-size: 1.25rem;
            }

            .sync-status-btn {
                padding: 0.5rem;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: -280px;
                width: 280px;
                height: 100vh;
                height: 100dvh;
                z-index: 1000;
                transition: left 0.3s ease;
                box-shadow: var(--shadow-md);
                padding-top: 60px;
                padding-bottom: env(safe-area-inset-bottom, 20px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }

            .sidebar.mobile-open {
                left: 0;
            }

            .sidebar-btn {
                padding: 0.875rem 1rem;
                min-height: 48px;
            }

            .mobile-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .mobile-overlay.active {
                display: block;
            }

            body.menu-open {
                overflow: hidden;
                position: fixed;
                width: 100%;
            }

            .content-area {
                padding: 1rem;
                padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
                margin-left: 0;
            }

            .main-container {
                flex-direction: column;
            }

            .notes-layout {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .greeting {
                font-size: 1.4rem;
            }

            .date-display {
                font-size: 0.9rem;
            }

            .view-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .view-title {
                font-size: 1.25rem;
            }

            .card {
                margin-bottom: 1rem;
                border-radius: 10px;
            }

            .card-header {
                padding: 0.875rem 1rem;
                flex-direction: row;
                align-items: center;
                gap: 0.5rem;
            }

            .card-title {
                font-size: 0.95rem;
            }

            .card-body {
                padding: 1rem;
            }

            /* Better touch targets for buttons */
            .btn {
                min-height: 44px;
                padding: 0.625rem 1rem;
                font-size: 0.9rem;
            }

            .btn-small {
                min-height: 38px;
                padding: 0.5rem 0.875rem;
                font-size: 0.85rem;
            }

            /* Quick log improvements */
            .quick-log-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.625rem;
            }

            .quick-log-btn {
                padding: 0.75rem 0.5rem;
                font-size: 0.7rem;
                min-height: 70px;
                border-radius: 10px;
            }

            .quick-log-btn span:first-child {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }

            /* Form inputs */
            .input-field, .form-control, select, textarea {
                min-height: 44px;
                font-size: 16px; /* Prevents iOS zoom */
                padding: 0.625rem 0.875rem;
            }

            .form-group {
                margin-bottom: 1rem;
            }

            .form-label {
                font-size: 0.85rem;
                margin-bottom: 0.375rem;
            }

            /* Modal improvements */
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }

            .modal {
                margin: 0;
                max-height: 90vh;
                max-height: 90dvh;
                width: 100%;
                border-radius: 16px 16px 0 0;
                padding: 1.25rem;
                padding-bottom: calc(1.25rem + env(safe-area-inset-bottom, 0px));
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .modal-actions {
                flex-direction: column;
                gap: 0.5rem;
            }

            .modal-actions .btn {
                width: 100%;
            }

            /* Task list improvements */
            .task-item {
                padding: 0.875rem;
                flex-wrap: nowrap;
                gap: 0.75rem;
            }

            .task-checkbox {
                width: 22px;
                height: 22px;
                flex-shrink: 0;
            }

            .task-content {
                flex: 1;
                min-width: 0;
            }

            .task-title {
                font-size: 0.9rem;
                word-break: break-word;
            }

            .task-meta {
                font-size: 0.75rem;
                flex-wrap: wrap;
                gap: 0.375rem;
            }

            .task-actions {
                flex-shrink: 0;
                margin-top: 0;
                width: auto;
            }

            .task-actions .btn {
                min-height: 36px;
                min-width: 36px;
                padding: 0.375rem;
            }

            /* Notes improvements */
            .notes-sidebar {
                max-height: 180px;
                margin-bottom: 1rem;
            }

            .note-card {
                padding: 0.875rem;
            }

            .notes-textarea {
                min-height: 200px;
                font-size: 16px;
            }

            #noteTitle {
                font-size: 16px;
            }

            /* Stats grid */
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .stat-card {
                padding: 0.875rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            /* Consumption/Research list */
            .consumption-item, .research-item {
                padding: 0.875rem;
            }

            /* Workout/Recipe cards */
            .workout-day, .recipe-day {
                padding: 1rem;
            }

            /* Settings */
            .card .form-group:last-child {
                margin-bottom: 0;
            }

            /* Table responsiveness */
            table {
                font-size: 0.8rem;
            }

            th, td {
                padding: 0.5rem 0.375rem;
            }

            /* Oura data table */
            .oura-day-row td {
                padding: 0.625rem 0.25rem;
            }

            /* Sync modal */
            .sync-modal {
                right: 0.5rem;
                left: 0.5rem;
                width: auto;
            }
        }

        @media (max-width: 480px) {
            .content-area {
                padding: 0.75rem;
                padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
            }

            .greeting {
                font-size: 1.25rem;
            }

            .quick-log-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .quick-log-btn {
                min-height: 65px;
                padding: 0.625rem 0.375rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .logo {
                font-size: 1.1rem;
            }

            .sidebar {
                width: 260px;
                left: -260px;
            }

            .card-header {
                padding: 0.75rem;
            }

            .card-body {
                padding: 0.75rem;
            }

            /* Form row stacking */
            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-row .form-group {
                width: 100%;
            }

            /* Hydration display */
            .hydration-count {
                font-size: 2.5rem;
            }

            /* Table horizontal scroll */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 500px;
            }
        }

        /* Extra small devices */
        @media (max-width: 360px) {
            .header {
                padding: 0.5rem 0.75rem;
            }

            .logo {
                font-size: 1rem;
            }

            .quick-log-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .quick-log-btn span:first-child {
                font-size: 1.25rem;
            }

            .quick-log-btn {
                font-size: 0.65rem;
                min-height: 60px;
            }

            .modal {
                padding: 1rem;
                padding-bottom: calc(1rem + env(safe-area-inset-bottom, 0px));
            }
        }
    </style>
</head>
<body>
    <!-- Password Protection Screen -->
    <div id="lockScreen" class="lock-screen">
        <div class="lock-container">
            <div class="lock-logo">Dean<span>OS</span></div>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Enter password to continue</p>
            <input type="password" id="passwordInput" class="input-field" placeholder="Password" style="text-align: center; max-width: 250px;" onkeypress="if(event.key==='Enter') checkPassword()">
            <button class="btn btn-primary" onclick="checkPassword()" style="margin-top: 1rem; width: 100%; max-width: 250px;">Unlock</button>
            <p id="passwordError" style="color: var(--red-soft); margin-top: 1rem; display: none;">Incorrect password</p>
        </div>
    </div>

    <!-- Main App (hidden until authenticated) -->
    <div id="mainApp" style="display: none;">

    <!-- Header -->
    <header class="header">
        <button class="mobile-menu-btn" onclick="toggleMobileMenu()" aria-label="Menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="logo">Dean<span>OS</span></div>
        <button class="sync-status-btn" id="syncStatusBtn" onclick="showSyncModal()" title="Sync Status">
            <span class="sync-icon" id="syncIcon">&#9729;</span>
        </button>
    </header>

    <!-- Sync Modal -->
    <div class="sync-modal" id="syncModal">
        <div class="sync-modal-header">
            <span>&#9729; Cloud Sync</span>
            <button class="sync-modal-close" onclick="closeSyncModal()">&times;</button>
        </div>
        <div class="sync-modal-status" id="syncModalStatus">
            Checking sync status...
        </div>
        <div class="sync-modal-buttons">
            <button class="btn btn-primary" onclick="quickSync()">Sync Up</button>
            <button class="btn btn-secondary" onclick="quickRestore()">Pull Down</button>
        </div>
    </div>

    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileMenu()"></div>

    <div class="main-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-label">Daily</div>
                <button class="sidebar-btn active" data-view="morning">
                    <span class="sidebar-icon">&#9728;</span> Morning
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Track</div>
                <button class="sidebar-btn" data-view="health">
                    <span class="sidebar-icon">&#128154;</span> Health
                </button>
                <button class="sidebar-btn" data-view="tasks">
                    <span class="sidebar-icon">&#9745;</span> Tasks
                </button>
                <button class="sidebar-btn" data-view="consumption">
                    <span class="sidebar-icon">&#127916;</span> Consumed
                </button>
                <button class="sidebar-btn" data-view="watchlist">
                    <span class="sidebar-icon">&#128209;</span> Watchlist
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Plan</div>
                <button class="sidebar-btn" data-view="planner">
                    <span class="sidebar-icon">&#128197;</span> Weekly Planner
                </button>
                <button class="sidebar-btn" data-view="nutrition">
                    <span class="sidebar-icon">&#129367;</span> Nutrition Log
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Reflect</div>
                <button class="sidebar-btn" data-view="notes">
                    <span class="sidebar-icon">&#128221;</span> Notes
                </button>
                <button class="sidebar-btn" data-view="research">
                    <span class="sidebar-icon">&#128218;</span> Research
                </button>
            </div>
            <div class="sidebar-section">
                <div class="sidebar-label">Progress</div>
                <button class="sidebar-btn" data-view="insights">
                    <span class="sidebar-icon">&#128200;</span> Insights
                </button>
                <button class="sidebar-btn" data-view="yearlyTracker">
                    <span class="sidebar-icon">&#128197;</span> 2026 Tracker
                </button>
            </div>
            <div class="sidebar-section" style="margin-top: auto;">
                <button class="sidebar-btn" data-view="settings">
                    <span class="sidebar-icon">&#9881;</span> Settings
                </button>
            </div>
        </nav>

        <!-- Content -->
        <main class="content-area">
            <!-- Morning Dashboard -->
            <div class="module-view active" id="morningView">
                <div class="greeting" id="greeting">Good morning, Dean</div>
                <div class="date-display" id="dateDisplay"></div>


                <div class="dashboard-grid">
                    <!-- Today's Priorities -->
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">&#127919; Today's Priorities</div>
                            <button class="btn btn-small btn-secondary" onclick="openTaskModal()">+ Add</button>
                        </div>
                        <div class="card-body" id="todayTasks">
                            <div class="empty-state">
                                <p>No tasks for today</p>
                            </div>
                        </div>
                    </div>

                    <!-- Meal Tracker -->
                    <div class="card" id="mealTrackerCard">
                        <div class="card-header">
                            <div class="card-title">&#127858; Yesterday's Meals</div>
                            <span style="font-size: 0.85rem; color: var(--text-secondary);" id="mealTrackerDate"></span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Breakfast</label>
                                <textarea class="input-field" id="mealBreakfast" rows="2" placeholder="What did you eat?"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lunch</label>
                                <textarea class="input-field" id="mealLunch" rows="2" placeholder="What did you eat?"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dinner</label>
                                <textarea class="input-field" id="mealDinner" rows="2" placeholder="What did you eat?"></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Snacks</label>
                                <textarea class="input-field" id="mealSnacks" rows="2" placeholder="What did you snack on?"></textarea>
                            </div>
                            <button class="btn btn-primary btn-small" onclick="saveMealTracker()" style="margin-top: 0.5rem; width: 100%;">Save Meals</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health View -->
            <div class="module-view" id="healthView">
                <div class="view-header">
                    <h2 class="view-title">&#128154; Health Hub</h2>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#128141; Oura Ring Data</div>
                        <button class="btn btn-secondary" onclick="syncOuraData()" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Sync</button>
                    </div>
                    <div class="card-body" id="ouraDataDisplay">
                        <div class="empty-state">
                            <p style="color: var(--text-secondary);">No Oura data synced</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Add your Oura token in Settings to sync sleep and HRV data.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tasks View -->
            <div class="module-view" id="tasksView">
                <div class="view-header">
                    <h2 class="view-title">&#9745; Tasks</h2>
                    <button class="btn btn-primary" onclick="openTaskModalWithContext()">+ Add Task</button>
                </div>

                <div class="consumption-tabs" id="taskTabs">
                    <button class="consumption-tab active" data-tasktab="work">&#128188; Work</button>
                    <button class="consumption-tab" data-tasktab="personal">&#127968; Personal</button>
                </div>

                <div id="workTasksSection">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">&#128188; Work - Short Term</div>
                        </div>
                        <div class="card-body" id="workShortTasks">
                            <div class="empty-state"><p>No tasks</p></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">&#128188; Work - Long Term</div>
                        </div>
                        <div class="card-body" id="workLongTasks">
                            <div class="empty-state"><p>No tasks</p></div>
                        </div>
                    </div>
                    <!-- Work Completed Tasks -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleCompletedTasks('work')">
                            <div class="card-title">&#9989; Completed</div>
                            <span id="workCompletedToggle" style="color: var(--text-muted); font-size: 0.85rem;">Show</span>
                        </div>
                        <div class="card-body" id="workCompletedSection" style="display: none;">
                            <div id="workCompletedList">
                                <div class="empty-state"><p>No completed work tasks</p></div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="clearCompletedTasks('work')" style="margin-top: 1rem; display: none;" id="workClearCompletedBtn">Clear All Completed</button>
                        </div>
                    </div>
                </div>

                <div id="personalTasksSection" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">&#127968; Personal - Short Term</div>
                        </div>
                        <div class="card-body" id="personalShortTasks">
                            <div class="empty-state"><p>No tasks</p></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">&#127968; Personal - Long Term</div>
                        </div>
                        <div class="card-body" id="personalLongTasks">
                            <div class="empty-state"><p>No tasks</p></div>
                        </div>
                    </div>
                    <!-- Personal Completed Tasks -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleCompletedTasks('personal')">
                            <div class="card-title">&#9989; Completed</div>
                            <span id="personalCompletedToggle" style="color: var(--text-muted); font-size: 0.85rem;">Show</span>
                        </div>
                        <div class="card-body" id="personalCompletedSection" style="display: none;">
                            <div id="personalCompletedList">
                                <div class="empty-state"><p>No completed personal tasks</p></div>
                            </div>
                            <button class="btn btn-secondary btn-small" onclick="clearCompletedTasks('personal')" style="margin-top: 1rem; display: none;" id="personalClearCompletedBtn">Clear All Completed</button>
                        </div>
                    </div>
                </div>

                <!-- All Tasks Complete Animation -->
                <div id="tasksCompleteAnimation" class="tasks-complete-animation" style="display: none;">
                    <div class="confetti-container">
                        <div class="celebration-text">All Tasks Complete!</div>
                    </div>
                </div>
            </div>

            <!-- Consumption View -->
            <div class="module-view" id="consumptionView">
                <div class="view-header">
                    <h2 class="view-title">&#127916; Consumed</h2>
                    <button class="btn btn-primary" onclick="openConsumptionModalWithContext()">+ Add</button>
                </div>

                <div class="consumption-tabs">
                    <button class="consumption-tab active" data-tab="tvshow">&#128250; TV Shows</button>
                    <button class="consumption-tab" data-tab="movie">&#127910; Movies</button>
                    <button class="consumption-tab" data-tab="book">&#128218; Books</button>
                    <button class="consumption-tab" data-tab="recipe">&#127869; Recipes</button>
                    <button class="consumption-tab" data-tab="restaurant">&#127860; Restaurants</button>
                </div>

                <div id="consumptionList"></div>
            </div>

            <!-- Watchlist View -->
            <div class="module-view" id="watchlistView">
                <div class="view-header">
                    <h2 class="view-title">&#128209; Watchlist</h2>
                    <button class="btn btn-primary" onclick="openWatchlistModalWithContext()">+ Add</button>
                </div>

                <div class="consumption-tabs" id="watchlistTabs">
                    <button class="consumption-tab active" data-watchlisttab="movie">&#127910; Movies</button>
                    <button class="consumption-tab" data-watchlisttab="tvshow">&#128250; TV Shows</button>
                    <button class="consumption-tab" data-watchlisttab="book">&#128218; Books</button>
                    <button class="consumption-tab" data-watchlisttab="game">&#127918; Games</button>
                    <button class="consumption-tab" data-watchlisttab="article">&#128196; Articles</button>
                </div>

                <div id="watchlistList"></div>
            </div>

            <!-- Notes View -->
            <div class="module-view" id="notesView">
                <div class="view-header">
                    <h2 class="view-title">&#128221; Notes</h2>
                </div>

                <div class="notes-layout">
                    <div class="notes-sidebar">
                        <button class="btn btn-primary btn-small" onclick="newNote()" style="width: 100%; margin-bottom: 1rem;">+ New Note</button>
                        <div id="notesList"></div>
                    </div>
                    <div class="notes-editor">
                        <input type="text" class="input-field" id="noteTitle" placeholder="Note title..." style="margin-bottom: 1rem; font-weight: 600;">
                        <textarea class="notes-textarea" id="noteContent" placeholder="Write your note here... ideas, reminders, lists, anything you need to remember."></textarea>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <button class="btn btn-primary" onclick="saveNote()">Save Note</button>
                            <button class="btn btn-secondary" onclick="deleteCurrentNote()" id="deleteNoteBtn" style="display: none;">Delete</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Research View -->
            <div class="module-view" id="researchView">
                <div class="view-header">
                    <h2 class="view-title">&#128218; Research</h2>
                    <button class="btn btn-primary" onclick="openNoteModal()">+ Add Note</button>
                </div>

                <div class="form-group">
                    <input type="text" class="input-field" id="researchSearch" placeholder="Search notes..." oninput="searchNotes()">
                </div>

                <!-- POTS Research Library -->
                <div class="pots-research-section">
                    <div class="card-header" style="padding: 0 0 1rem;">
                        <div class="card-title">POTS Research Library</div>
                        <span style="font-size: 0.8rem; color: var(--text-secondary);">Comprehensive guide compiled from 2025 research</span>
                    </div>
                    <div class="pots-category-tabs" id="potsCategoryTabs"></div>
                    <div id="potsResearchContent">
                        <div class="empty-state"><p>Loading POTS research...</p></div>
                    </div>
                </div>

                <div id="notesList"></div>
            </div>

            <!-- Insights View -->
            <div class="module-view" id="insightsView">
                <div class="view-header">
                    <h2 class="view-title">&#128200; Insights</h2>
                </div>

                <div id="insightsList">
                    <div class="insight-card">
                        <div class="insight-icon">&#128161;</div>
                        <div class="insight-text">Keep logging data to unlock personalized insights about your patterns!</div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <div class="card-title">Your Stats</div>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid" id="overallStats"></div>
                    </div>
                </div>
            </div>

            <!-- Weekly Planner View -->
            <div class="module-view" id="plannerView">
                <div class="view-header">
                    <h2 class="view-title">&#128197; Weekly Planner</h2>
                    <div class="planner-nav">
                        <span class="planner-week-label" id="plannerWeekLabel"></span>
                        <button class="planner-nav-btn" onclick="plannerPrevWeek()">&#9664;</button>
                        <button class="planner-nav-btn" onclick="plannerCurrentWeek()">Today</button>
                        <button class="planner-nav-btn" onclick="plannerNextWeek()">&#9654;</button>
                    </div>
                </div>

                <div class="consumption-tabs" id="plannerTabs">
                    <button class="consumption-tab active" data-plannertab="week">Week Overview</button>
                    <button class="consumption-tab" data-plannertab="day">Day View</button>
                    <button class="consumption-tab" data-plannertab="grocery">Grocery List</button>
                </div>

                <div id="plannerWeekView"></div>

                <div id="plannerDayView" style="display: none;">
                    <div class="planner-day-selector" id="plannerDaySelector"></div>
                    <div id="plannerDayContent"></div>
                </div>

                <div id="plannerGroceryView" style="display: none;"></div>
            </div>

            <!-- Nutrition Log View -->
            <div class="module-view" id="nutritionView">
                <div class="view-header">
                    <h2 class="view-title">&#129367; Nutrition Log</h2>
                </div>

                <!-- Weekly Nutrition Report -->
                <div class="card" id="nutritionReportCard">
                    <div class="card-header">
                        <div class="card-title">&#128202; Weekly Nutrition Analysis</div>
                        <span id="nutritionReportDate" style="font-size: 0.85rem; color: var(--text-secondary);"></span>
                    </div>
                    <div class="card-body" id="nutritionReportContent">
                        <div class="empty-state">
                            <p style="color: var(--text-secondary);">No nutrition report yet</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Log your meals daily and connect GitHub sync in Settings to receive weekly insights every Saturday.</p>
                        </div>
                    </div>
                </div>

                <!-- Meal Log History -->
                <div class="card" style="margin-top: 1.5rem;">
                    <div class="card-header">
                        <div class="card-title">&#128221; Meal Log History</div>
                        <button class="btn btn-primary" onclick="openAddMealModal()" style="font-size: 0.85rem; padding: 0.4rem 0.8rem;">+ Add Meal Log</button>
                    </div>
                    <div class="card-body" id="mealLogHistory">
                        <p style="color: var(--text-secondary);">Loading meal history...</p>
                    </div>
                </div>
            </div>

            <!-- Yearly Tracker View -->
            <div class="module-view" id="yearlyTrackerView">
                <div class="view-header">
                    <h2 class="view-title">&#128197; 2026 Year Tracker</h2>
                </div>

                <!-- Consumption Stats -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <div class="card-title">&#127916; Media & Dining Consumed</div>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="yearBooks">0</div>
                                <div class="stat-label">Books</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="yearMovies">0</div>
                                <div class="stat-label">Movies</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="yearTVShows">0</div>
                                <div class="stat-label">TV Shows</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="yearRecipes">0</div>
                                <div class="stat-label">Recipes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="yearRestaurants">0</div>
                                <div class="stat-label">Restaurants</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Books List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#128218; Books</div>
                    </div>
                    <div class="card-body" id="yearBooksList">
                        <div class="empty-state"><p>No books logged yet</p></div>
                    </div>
                </div>

                <!-- Movies List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#127910; Movies</div>
                    </div>
                    <div class="card-body" id="yearMoviesList">
                        <div class="empty-state"><p>No movies logged yet</p></div>
                    </div>
                </div>

                <!-- TV Shows List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#128250; TV Shows</div>
                    </div>
                    <div class="card-body" id="yearTVShowsList">
                        <div class="empty-state"><p>No TV shows logged yet</p></div>
                    </div>
                </div>

                <!-- Restaurants List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#127860; Restaurants</div>
                    </div>
                    <div class="card-body" id="yearRestaurantsList">
                        <div class="empty-state"><p>No restaurants logged yet</p></div>
                    </div>
                </div>

                <!-- Recipes List -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#127869; Recipes Cooked</div>
                    </div>
                    <div class="card-body" id="yearRecipesList">
                        <div class="empty-state"><p>No recipes logged yet</p></div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div class="module-view" id="settingsView">
                <div class="view-header">
                    <h2 class="view-title">&#9881; Settings</h2>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#9729; Cloud Sync</div>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                            Sync all your data (tasks, notes, consumption, daily logs) across devices using a private GitHub Gist. Your data stays private and accessible from any device.
                        </p>
                        <div class="form-group">
                            <label class="form-label">GitHub Personal Access Token</label>
                            <input type="password" class="input-field" id="githubToken" placeholder="ghp_xxxxxxxxxxxx">
                            <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                                Create at github.com/settings/tokens with "gist" scope only.
                            </small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Gist ID (auto-created if empty)</label>
                            <input type="text" class="input-field" id="gistId" placeholder="Will be created automatically">
                            <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                                Leave blank on first setup. Copy this ID to other devices to sync.
                            </small>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="saveGitHubSettings()">Save Settings</button>
                            <button class="btn btn-secondary" onclick="syncAllDataToCloud()">Sync to Cloud</button>
                            <button class="btn btn-secondary" onclick="restoreFromCloud()">Restore from Cloud</button>
                        </div>
                        <div id="syncStatus" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <div class="card-title">&#128203; Sync Status</div>
                    </div>
                    <div class="card-body">
                        <div id="lastSyncInfo">
                            <p style="color: var(--text-secondary);">No sync performed yet</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <div class="card-title">&#128141; Oura Ring Integration</div>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                            Sync your Oura Ring data using the Python script. Due to browser security restrictions, Oura data must be fetched via command line.
                        </p>
                        <div style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-sm); margin-bottom: 1rem;">
                            <p style="font-weight: 600; margin-bottom: 0.5rem;">How to sync:</p>
                            <ol style="margin: 0; padding-left: 1.25rem; font-size: 0.9rem; color: var(--text-secondary);">
                                <li style="margin-bottom: 0.25rem;">Get your token from <a href="https://cloud.ouraring.com/personal-access-tokens" target="_blank" style="color: var(--forest);">cloud.ouraring.com/personal-access-tokens</a></li>
                                <li style="margin-bottom: 0.25rem;">Run in terminal:<br><code style="background: var(--bg-card); padding: 0.25rem 0.5rem; border-radius: 4px; display: inline-block; margin-top: 0.25rem; font-size: 0.85rem;">OURA_PAT=your_token_here python3 scripts/sync_oura.py</code></li>
                                <li>Click "Load Oura Data" below or refresh the page</li>
                            </ol>
                        </div>
                        <button class="btn btn-secondary" onclick="loadOuraFromFile()">Load Oura Data</button>
                        <div id="ouraStatus" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <div class="card-title">&#128214; Goodreads Integration</div>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                            Your Goodreads "to-read" shelf syncs weekly via GitHub Actions. Books appear in Watchlist &gt; Books.
                        </p>
                        <div style="background: var(--bg-input); padding: 1rem; border-radius: var(--radius-sm);">
                            <p style="font-weight: 600; margin-bottom: 0.5rem;">Setup:</p>
                            <ol style="margin: 0; padding-left: 1.25rem; font-size: 0.9rem; color: var(--text-secondary);">
                                <li style="margin-bottom: 0.25rem;">Go to <a href="https://www.goodreads.com/review/list" target="_blank" style="color: var(--forest);">goodreads.com/review/list</a> and click the RSS link at the bottom</li>
                                <li style="margin-bottom: 0.25rem;">Your RSS URL looks like: <code style="font-size: 0.8rem;">goodreads.com/review/list_rss/USER_ID?key=RSS_KEY&amp;shelf=to-read</code></li>
                                <li style="margin-bottom: 0.25rem;">Add <code>GOODREADS_USER_ID</code> and <code>GOODREADS_RSS_KEY</code> as GitHub repository secrets</li>
                                <li>The feed syncs every Sunday, or trigger manually from GitHub Actions</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <div class="card-title">&#128272; Security</div>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Change Password</label>
                            <input type="password" class="input-field" id="newPassword" placeholder="New password (min 4 characters)">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Confirm Password</label>
                            <input type="password" class="input-field" id="confirmPassword" placeholder="Confirm new password">
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
                            <button class="btn btn-secondary" onclick="logout()" style="background: var(--red-bg); color: var(--red-soft);">Logout</button>
                        </div>
                        <div id="passwordChangeStatus" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 1rem;">
                    <div class="card-header">
                        <div class="card-title">&#128465; Data Management</div>
                    </div>
                    <div class="card-body">
                        <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                            Export or clear your local data. Data is stored in your browser's localStorage.
                        </p>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                            <button class="btn btn-secondary" onclick="if(confirm('Are you sure? This will delete ALL your data and cannot be undone.')){localStorage.clear(); location.reload();}" style="background: var(--red-bg); color: var(--red-soft);">Clear All Data</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Task Modal -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <h3 class="modal-title" id="taskModalTitle">Add Task</h3>
            <div class="form-group">
                <label class="form-label">What needs to be done?</label>
                <input type="text" class="input-field" id="taskTitle" placeholder="Task description">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="input-field" id="taskCategory">
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Term</label>
                    <select class="input-field" id="taskTerm">
                        <option value="short" selected>Short Term</option>
                        <option value="long">Long Term</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="input-field" id="taskPriority">
                        <option value="high">High</option>
                        <option value="medium" selected>Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Due Date (optional)</label>
                    <input type="date" class="input-field" id="taskDueDate">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeTaskModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addTask()" id="taskSubmitBtn">Add Task</button>
            </div>
        </div>
    </div>

    <!-- Consumption Modal -->
    <div class="modal-overlay" id="consumptionModal">
        <div class="modal">
            <h3 class="modal-title" id="consumptionModalTitle">Log Something You Consumed</h3>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="input-field" id="consumptionType">
                    <option value="tvshow">TV Show</option>
                    <option value="movie">Movie</option>
                    <option value="book">Book</option>
                    <option value="recipe">Recipe</option>
                    <option value="restaurant">Restaurant</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="input-field" id="consumptionTitle" placeholder="What did you consume?">
            </div>
            <div class="form-group is-hidden" id="consumptionUrlGroup">
                <label class="form-label">URL (optional)</label>
                <input type="url" class="input-field" id="consumptionUrl" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" class="input-field" id="consumptionDate">
            </div>
            <div class="form-group">
                <label class="form-label">Score (1-100)</label>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <input type="range" min="1" max="100" value="70" id="consumptionScore" style="flex: 1;" oninput="updateScoreDisplay()">
                    <span id="consumptionScoreDisplay" style="font-size: 1.5rem; font-weight: 700; color: var(--forest); min-width: 50px; text-align: center;">70</span>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Notes/Thoughts</label>
                <textarea class="input-field" id="consumptionNotes" rows="3" placeholder="What did you think?"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeConsumptionModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addConsumption()" id="consumptionSubmitBtn">Add</button>
            </div>
        </div>
    </div>

    <!-- Watchlist Modal -->
    <div class="modal-overlay" id="watchlistModal">
        <div class="modal">
            <h3 class="modal-title" id="watchlistModalTitle">Add to Watchlist</h3>
            <div class="form-group">
                <label class="form-label">Type</label>
                <select class="input-field" id="watchlistType">
                    <option value="movie">Movie</option>
                    <option value="tvshow">TV Show</option>
                    <option value="book">Book</option>
                    <option value="game">Game</option>
                    <option value="article">Article</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="input-field" id="watchlistTitle" placeholder="What do you want to watch/read/play?">
            </div>
            <div class="form-group">
                <label class="form-label">URL (optional)</label>
                <input type="url" class="input-field" id="watchlistUrl" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <textarea class="input-field" id="watchlistNotes" rows="2" placeholder="Who recommended it? Why does it interest you?"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeWatchlistModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addWatchlistItem()" id="watchlistSubmitBtn">Add</button>
            </div>
        </div>
    </div>

    <!-- Note Modal -->
    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <h3 class="modal-title">Add Research Note</h3>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="input-field" id="noteTitle" placeholder="Note title">
            </div>
            <div class="form-group">
                <label class="form-label">URL (optional)</label>
                <input type="url" class="input-field" id="noteUrl" placeholder="https://...">
            </div>
            <div class="form-group">
                <label class="form-label">Category</label>
                <select class="input-field" id="noteCategory">
                    <option value="health">Health Research</option>
                    <option value="learning">Learning</option>
                    <option value="work">Work Reference</option>
                    <option value="ideas">Ideas</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Content</label>
                <textarea class="input-field" id="noteContent" rows="5" placeholder="Your note..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Tags (comma-separated)</label>
                <input type="text" class="input-field" id="noteTags" placeholder="pots, treatment, research">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeNoteModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addNote()">Add Note </button>
            </div>
        </div>
    </div>

    <!-- Edit Meal Modal -->
    <div class="modal-overlay" id="editMealModal">
        <div class="modal" style="max-width: 420px;">
            <h3 class="modal-title" id="editMealModalTitle">Edit Meals</h3>
            <div class="form-group" id="editMealDateGroup" style="display: none;">
                <label class="form-label">Date</label>
                <input type="date" class="input-field" id="editMealDatePicker">
            </div>
            <div class="form-group" style="margin-bottom: 0.875rem;">
                <label class="form-label">Breakfast</label>
                <input type="text" class="input-field" id="editMealBreakfast" placeholder="What did you eat?">
            </div>
            <div class="form-group" style="margin-bottom: 0.875rem;">
                <label class="form-label">Lunch</label>
                <input type="text" class="input-field" id="editMealLunch" placeholder="What did you eat?">
            </div>
            <div class="form-group" style="margin-bottom: 0.875rem;">
                <label class="form-label">Dinner</label>
                <input type="text" class="input-field" id="editMealDinner" placeholder="What did you eat?">
            </div>
            <div class="form-group" style="margin-bottom: 0.875rem;">
                <label class="form-label">Snacks</label>
                <input type="text" class="input-field" id="editMealSnacks" placeholder="What did you snack on?">
            </div>
            <input type="hidden" id="editMealDate">
            <input type="hidden" id="editMealMode" value="edit">
            <div class="modal-actions" style="margin-top: 1rem; padding-top: 1rem;">
                <button class="btn btn-secondary" onclick="closeEditMealModal()">Cancel</button>
                <button class="btn btn-primary" id="editMealSubmitBtn" onclick="saveEditedMeal()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Year Item Modal -->
    <div class="modal-overlay" id="yearItemModal">
        <div class="modal">
            <h3 class="modal-title" id="yearItemModalTitle">Add Item</h3>
            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="input-field" id="yearItemTitle" placeholder="Title">
            </div>
            <div class="form-group">
                <label class="form-label">Notes (optional)</label>
                <textarea class="input-field" id="yearItemNotes" rows="2" placeholder="Any thoughts..."></textarea>
            </div>
            <input type="hidden" id="yearItemType">
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeYearItemModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addYearItem()">Add</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DATA LAYER ====================
        const DEFAULT_DATA = {
            user: {
                name: 'Dean',
                level: 1,
                xp: 0,
                achievements: [],
                streakDays: 0,
                lastActiveDate: null
            },
            dailyLogs: {}, // Keyed by date string: { water, salt, protein, meds, creatine, compression, exercise, instagram, twitter, sugar, junkfood, bedtime, waketime, screenTime, ouraScore }
            vitals: [],
            symptoms: [],
            tasks: [],
            consumption: [],
            watchlist: [],
            notes: [],
            quickLogs: {}, // Keyed by date string
            yearlyItems: {
                books: [],
                podcasts: [],
                meals: [],
                workouts: []
            },
            weeklyPlanner: {},
            groceryList: { items: [] }
        };

        function countUniqueDays(arr) {
            const dates = new Set(arr.map(item => new Date(item.date).toDateString()));
            return dates.size;
        }

        function loadData() {
            const stored = localStorage.getItem('deanOSData');
            if (stored) {
                const data = JSON.parse(stored);
                return { ...DEFAULT_DATA, ...data, user: { ...DEFAULT_DATA.user, ...data.user } };
            }
            return JSON.parse(JSON.stringify(DEFAULT_DATA));
        }

        function saveData() {
            localStorage.setItem('deanOSData', JSON.stringify(appData));
            // Debounced auto-sync to cloud
            scheduleCloudSync();
        }

        let cloudSyncTimeout = null;
        function scheduleCloudSync() {
            // Debounce: wait 30 seconds after last change before syncing
            if (cloudSyncTimeout) clearTimeout(cloudSyncTimeout);
            cloudSyncTimeout = setTimeout(() => {
                const settings = getGitHubSettings();
                if (settings.token && settings.gistId) {
                    syncAllDataToCloud().catch(err => console.log('Auto-sync skipped:', err));
                }
            }, 30000); // 30 second debounce
        }

        let appData = loadData();

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getToday() {
            return new Date().toISOString().split('T')[0];
        }

        function getYesterday() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        }

        function createEmptyLog() {
            return {
                water: 0,
                salt: 0,
                protein: 0,
                meds: false,
                creatine: false,
                compression: false,
                exercise: false,
                instagram: false,
                twitter: false,
                sugar: false,
                junkfood: false,
                bedtime: '',
                waketime: '',
                screenTime: 0,
                ouraScore: 0,
                meals: {
                    breakfast: '',
                    lunch: '',
                    dinner: '',
                    snacks: ''
                }
            };
        }

        function getLogByDate(dateStr) {
            if (!appData.dailyLogs[dateStr]) {
                appData.dailyLogs[dateStr] = createEmptyLog();
            } else if (!appData.dailyLogs[dateStr].meals) {
                appData.dailyLogs[dateStr].meals = {
                    breakfast: '',
                    lunch: '',
                    dinner: '',
                    snacks: ''
                };
            }
            return appData.dailyLogs[dateStr];
        }

        function getTodayLog() {
            const today = getToday();
            return getLogByDate(today);
        }

        function normalizeUrl(url) {
            if (!url) return '';
            const trimmed = url.trim();
            if (!trimmed) return '';
            if (/^https?:\/\//i.test(trimmed)) return trimmed;
            return `https://${trimmed}`;
        }

        function createSearchUrl(query) {
            return `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        }

        function shuffleArray(items) {
            const copy = [...items];
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        }

        function pickRandomItems(items, count) {
            return shuffleArray(items).slice(0, Math.min(count, items.length));
        }

        function triggerMealPlanRefresh() {
            const container = document.getElementById('weeklyMealPlan');
            if (!container) return;
            container.classList.remove('mealplan-refresh');
            void container.offsetWidth;
            container.classList.add('mealplan-refresh');
            setTimeout(() => container.classList.remove('mealplan-refresh'), 500);
        }

        // ==================== NOTIFICATIONS ====================
        function showNotification(message, type = 'success') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.innerHTML = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        // ==================== NAVIGATION ====================
        let currentConsumptionTab = 'tvshow';
        let currentWatchlistTab = 'movie';
        let goodreadsFeedCache = null;
        let selectedTier = 'B';
        let selectedMood = 3;
        let researchFeedCache = null;
        let currentPlannerDay = null;
        let currentPlannerWeekKey = null;
        let currentPlannerTab = 'week';

        function showView(viewName) {
            document.querySelectorAll('.module-view').forEach(v => v.classList.remove('active'));
            document.getElementById(`${viewName}View`).classList.add('active');

            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.sidebar-btn[data-view="${viewName}"]`)?.classList.add('active');

            // Render view content
            if (viewName === 'morning') renderMorning();
            else if (viewName === 'health') renderHealth();
            else if (viewName === 'tasks') renderTasks();
            else if (viewName === 'consumption') renderConsumption();
            else if (viewName === 'watchlist') renderWatchlist();
            else if (viewName === 'notes') renderNotes();
            else if (viewName === 'research') renderResearch();
            else if (viewName === 'insights') renderInsights();
            else if (viewName === 'planner') renderPlanner();
            else if (viewName === 'nutrition') renderNutrition();
            else if (viewName === 'yearlyTracker') renderYearlyTracker();
            else if (viewName === 'settings') renderSettings();
        }

        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.addEventListener('click', () => showView(btn.dataset.view));
        });

        // ==================== MORNING DASHBOARD ====================
        function renderMorning() {
            // Update greeting based on time
            const hour = new Date().getHours();
            let greeting = 'Good morning';
            if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
            else if (hour >= 17) greeting = 'Good evening';
            document.getElementById('greeting').textContent = `${greeting}, Dean`;

            // Update date
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', options);

            // Update today's tasks
            renderTodayTasks();

            // Update meal tracker
            renderMealTracker();
        }

        function addSalt(amount) {
            const todayLog = getTodayLog();
            todayLog.salt = (todayLog.salt || 0) + amount;
            saveData();
            document.getElementById('saltTotal').textContent = todayLog.salt;
        }

        function addProtein(amount) {
            const todayLog = getTodayLog();
            todayLog.protein = (todayLog.protein || 0) + amount;
            saveData();
            document.getElementById('proteinTotal').textContent = todayLog.protein;
        }

        function saveSleepData() {
            const todayLog = getTodayLog();
            todayLog.bedtime = document.getElementById('bedtimeInput').value;
            todayLog.waketime = document.getElementById('waketimeInput').value;
            todayLog.screenTime = parseFloat(document.getElementById('screenTimeInput').value) || 0;
            todayLog.ouraScore = parseInt(document.getElementById('ouraScoreInput').value) || 0;

            saveData();
            showNotification('Sleep data logged!', 'success');
        }

        function addWater(amount) {
            const todayLog = getTodayLog();
            todayLog.water = Math.max(0, todayLog.water + amount);
            saveData();
            renderMorning();
        }

        function updateWaterFromSlider(value) {
            const todayLog = getTodayLog();
            const nextValue = Math.max(0, parseInt(value, 10) || 0);
            if (todayLog.water === nextValue) return;
            todayLog.water = nextValue;
            saveData();
            renderMorning();
        }

        function toggleSymptom(symptom) {
            const btn = document.querySelector(`[data-symptom="${symptom}"]`);
            btn.classList.toggle('active');
        }

        function logSymptoms() {
            const activeSymptoms = Array.from(document.querySelectorAll('.symptom-btn.active')).map(btn => btn.dataset.symptom);
            const overall = parseInt(document.getElementById('overallFeeling').value);

            appData.symptoms.push({
                id: generateId(),
                date: new Date().toISOString(),
                symptoms: activeSymptoms,
                overall
            });

            saveData();
        }

        // Auto-save symptoms when feeling changes (if the slider is present)
        const overallFeelingSlider = document.getElementById('overallFeeling');
        if (overallFeelingSlider) {
            overallFeelingSlider.addEventListener('change', logSymptoms);
        }

        // ==================== TASKS ====================
        let currentTaskTab = 'work';

        function openTaskModal() {
            editingTaskId = null;
            document.getElementById('taskModalTitle').textContent = 'Add Task';
            document.getElementById('taskSubmitBtn').textContent = 'Add Task';
            document.getElementById('taskModal').classList.add('active');
        }
        function openTaskModalWithContext() {
            editingTaskId = null;
            document.getElementById('taskModalTitle').textContent = 'Add Task';
            document.getElementById('taskSubmitBtn').textContent = 'Add Task';
            document.getElementById('taskCategory').value = currentTaskTab;
            document.getElementById('taskModal').classList.add('active');
        }
        function closeTaskModal() {
            document.getElementById('taskModal').classList.remove('active');
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDueDate').value = '';
            editingTaskId = null;
        }

        function addTask() {
            const title = document.getElementById('taskTitle').value.trim();
            if (!title) return;

            const priority = document.getElementById('taskPriority').value;
            const xpValues = { high: 20, medium: 10, low: 5 };

            if (editingTaskId) {
                // Update existing task
                const task = appData.tasks.find(t => t.id === editingTaskId);
                if (task) {
                    task.title = title;
                    task.priority = priority;
                    task.category = document.getElementById('taskCategory').value;
                    task.term = document.getElementById('taskTerm').value;
                    task.dueDate = document.getElementById('taskDueDate').value || null;
                    task.xpValue = xpValues[priority];
                }
                editingTaskId = null;
            } else {
                // Add new task
                appData.tasks.push({
                    id: generateId(),
                    title,
                    priority,
                    category: document.getElementById('taskCategory').value,
                    term: document.getElementById('taskTerm').value,
                    dueDate: document.getElementById('taskDueDate').value || null,
                    completed: false,
                    xpValue: xpValues[priority],
                    createdAt: new Date().toISOString()
                });
            }

            saveData();
            closeTaskModal();
            renderTasks();
            renderTodayTasks();
        }

        function toggleTask(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed) {
                    task.completedAt = new Date().toISOString();
                    checkAllTasksComplete();
                } else {
                    delete task.completedAt;
                }
                saveData();
                renderTasks();
                renderTodayTasks();
            }
        }

        function checkAllTasksComplete() {
            const incompleteTasks = appData.tasks.filter(t => !t.completed);
            if (appData.tasks.length > 0 && incompleteTasks.length === 0) {
                showTasksCompleteAnimation();
            }
        }

        function showTasksCompleteAnimation() {
            const anim = document.getElementById('tasksCompleteAnimation');
            anim.style.display = 'flex';
            setTimeout(() => {
                anim.style.display = 'none';
            }, 3000);
        }

        function deleteTask(id) {
            appData.tasks = appData.tasks.filter(t => t.id !== id);
            saveData();
            renderTasks();
            renderTodayTasks();
        }

        function renderTasks() {
            // Update tab highlighting
            document.querySelectorAll('#taskTabs .consumption-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tasktab === currentTaskTab);
            });

            // Show/hide sections
            document.getElementById('workTasksSection').style.display = currentTaskTab === 'work' ? 'block' : 'none';
            document.getElementById('personalTasksSection').style.display = currentTaskTab === 'personal' ? 'block' : 'none';

            // Render work tasks
            renderTaskSection('work', 'short', 'workShortTasks');
            renderTaskSection('work', 'long', 'workLongTasks');

            // Render personal tasks
            renderTaskSection('personal', 'short', 'personalShortTasks');
            renderTaskSection('personal', 'long', 'personalLongTasks');

            // Render completed tasks for both categories
            renderCompletedTasks('work');
            renderCompletedTasks('personal');
        }

        function renderCompletedTasks(category) {
            const container = document.getElementById(`${category}CompletedList`);
            const clearBtn = document.getElementById(`${category}ClearCompletedBtn`);
            const completedTasks = appData.tasks
                .filter(t => t.completed && t.category === category)
                .sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0));

            if (completedTasks.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>No completed ${category} tasks</p></div>`;
                if (clearBtn) clearBtn.style.display = 'none';
            } else {
                container.innerHTML = completedTasks.map(task => `
                    <div class="task-item completed" style="opacity: 0.7;">
                        <div class="task-checkbox checked" onclick="restoreTask('${task.id}')" title="Restore task">&#10003;</div>
                        <div class="task-content">
                            <div class="task-title" style="text-decoration: line-through;">${task.title}</div>
                            <div class="task-meta">
                                <span>${task.term === 'short' ? 'Short Term' : 'Long Term'}</span>
                                ${task.completedAt ? `<span>Completed ${new Date(task.completedAt).toLocaleDateString()}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn btn-icon btn-secondary" onclick="deleteTask('${task.id}')" title="Delete permanently" style="opacity: 0.5;">&#128465;</button>
                    </div>
                `).join('');
                if (clearBtn) clearBtn.style.display = 'block';
            }
        }

        function toggleCompletedTasks(category) {
            const section = document.getElementById(`${category}CompletedSection`);
            const toggle = document.getElementById(`${category}CompletedToggle`);
            const isHidden = section.style.display === 'none';
            section.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? 'Hide' : 'Show';
        }

        function restoreTask(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (task) {
                task.completed = false;
                delete task.completedAt;
                saveData();
                renderTasks();
                renderTodayTasks();
                showNotification('Task restored', 'success');
            }
        }

        function clearCompletedTasks(category) {
            if (confirm(`Delete all completed ${category} tasks? This cannot be undone.`)) {
                appData.tasks = appData.tasks.filter(t => !(t.completed && t.category === category));
                saveData();
                renderTasks();
                showNotification(`Completed ${category} tasks cleared`, 'success');
            }
        }

        function renderTaskSection(category, term, containerId) {
            const container = document.getElementById(containerId);
            const tasks = appData.tasks.filter(t => t.category === category && (t.term || 'short') === term && !t.completed);

            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tasks</p></div>';
            } else {
                container.innerHTML = tasks.map(task => renderTaskItem(task)).join('');
            }
        }

        // Task tab switching
        document.querySelectorAll('#taskTabs .consumption-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentTaskTab = tab.dataset.tasktab;
                renderTasks();
            });
        });

        function renderTodayTasks() {
            const container = document.getElementById('todayTasks');
            const today = getToday();
            const todayDate = new Date(`${today}T00:00:00`);
            const weekOut = new Date(todayDate);
            weekOut.setDate(weekOut.getDate() + 7);
            const todayTasks = appData.tasks
                .filter(t => !t.completed && t.dueDate)
                .map(t => ({ ...t, dueDateObj: new Date(`${t.dueDate}T00:00:00`) }))
                .filter(t => t.dueDateObj >= todayDate && t.dueDateObj <= weekOut)
                .sort((a, b) => a.dueDateObj - b.dueDateObj)
                .slice(0, 5);

            if (todayTasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No tasks due in the next week</p></div>';
            } else {
                container.innerHTML = todayTasks.map(task => renderTaskItem(task)).join('');
            }
        }

        function renderMealTracker() {
            const mealTrackerCard = document.getElementById('mealTrackerCard');
            const dateLabel = document.getElementById('mealTrackerDate');
            const breakfastInput = document.getElementById('mealBreakfast');
            const lunchInput = document.getElementById('mealLunch');
            const dinnerInput = document.getElementById('mealDinner');
            const snacksInput = document.getElementById('mealSnacks');

            if (!breakfastInput || !lunchInput || !dinnerInput || !snacksInput) return;

            const yesterday = getYesterday();
            const log = appData.dailyLogs[yesterday];
            const meals = log?.meals || {};

            // Hide the meal tracker if yesterday's meals have already been logged
            const hasMealsLogged = meals.breakfast || meals.lunch || meals.dinner || meals.snacks;
            if (mealTrackerCard) {
                mealTrackerCard.style.display = hasMealsLogged ? 'none' : 'block';
            }

            breakfastInput.value = meals.breakfast || '';
            lunchInput.value = meals.lunch || '';
            dinnerInput.value = meals.dinner || '';
            snacksInput.value = meals.snacks || '';

            if (dateLabel) {
                dateLabel.textContent = new Date(`${yesterday}T00:00:00`).toLocaleDateString('en-US', {
                    weekday: 'long',
                    month: 'long',
                    day: 'numeric'
                });
            }
        }

        function saveMealTracker() {
            const yesterday = getYesterday();
            const log = getLogByDate(yesterday);

            log.meals = {
                breakfast: document.getElementById('mealBreakfast').value.trim(),
                lunch: document.getElementById('mealLunch').value.trim(),
                dinner: document.getElementById('mealDinner').value.trim(),
                snacks: document.getElementById('mealSnacks').value.trim()
            };

            saveData();
            showNotification('Meals logged!', 'success');

            // Hide the meal tracker card after saving
            const mealTrackerCard = document.getElementById('mealTrackerCard');
            if (mealTrackerCard) {
                mealTrackerCard.style.display = 'none';
            }

            // Auto-sync to gist if configured
            const settings = getGitHubSettings();
            if (settings.token) {
                syncMealsToGist().then(result => {
                    if (result.success) {
                        showNotification('Synced to cloud', 'success');
                    }
                });
            }
        }

        function renderMealLogHistory() {
            const container = document.getElementById('mealLogHistory');
            if (!container) return;

            // Get all dates with meal logs, sorted newest first
            const mealDates = Object.keys(appData.dailyLogs)
                .filter(date => {
                    const log = appData.dailyLogs[date];
                    const meals = log.meals || {};
                    return meals.breakfast || meals.lunch || meals.dinner || meals.snacks;
                })
                .sort((a, b) => b.localeCompare(a))
                .slice(0, 14); // Show last 14 days

            if (mealDates.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="color: var(--text-secondary);">No meals logged yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Log yesterday's meals from the homepage to start tracking.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = mealDates.map(date => {
                const log = appData.dailyLogs[date];
                const meals = log.meals || {};
                const dateObj = new Date(date + 'T00:00:00');
                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                const dateDisplay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                const mealItems = [];
                if (meals.breakfast) mealItems.push(`<span style="color: var(--text-secondary);">B:</span> ${meals.breakfast}`);
                if (meals.lunch) mealItems.push(`<span style="color: var(--text-secondary);">L:</span> ${meals.lunch}`);
                if (meals.dinner) mealItems.push(`<span style="color: var(--text-secondary);">D:</span> ${meals.dinner}`);
                if (meals.snacks) mealItems.push(`<span style="color: var(--text-secondary);">S:</span> ${meals.snacks}`);

                return `
                    <div style="padding: 0.75rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--forest); margin-bottom: 0.25rem;">${dayName}, ${dateDisplay}</div>
                            <div style="font-size: 0.9rem; line-height: 1.5;">
                                ${mealItems.join('<br>')}
                            </div>
                        </div>
                        <button onclick="openEditMealModal('${date}')" style="background: none; border: none; cursor: pointer; padding: 0.25rem 0.5rem; color: var(--text-muted); font-size: 0.85rem;">
                            Edit
                        </button>
                    </div>
                `;
            }).join('');
        }

        function openAddMealModal() {
            // Set to add mode
            document.getElementById('editMealMode').value = 'add';
            document.getElementById('editMealModalTitle').textContent = 'Log Meals';
            document.getElementById('editMealSubmitBtn').textContent = 'Save';
            document.getElementById('editMealDateGroup').style.display = 'block';

            // Default to yesterday
            const yesterday = getYesterday();
            document.getElementById('editMealDatePicker').value = yesterday;
            document.getElementById('editMealDatePicker').max = new Date().toISOString().split('T')[0];

            // Clear fields
            document.getElementById('editMealBreakfast').value = '';
            document.getElementById('editMealLunch').value = '';
            document.getElementById('editMealDinner').value = '';
            document.getElementById('editMealSnacks').value = '';
            document.getElementById('editMealDate').value = '';

            document.getElementById('editMealModal').classList.add('active');
        }

        function openEditMealModal(dateStr) {
            const log = appData.dailyLogs[dateStr];
            const meals = log?.meals || {};

            const dateObj = new Date(dateStr + 'T00:00:00');
            const dateDisplay = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            // Set to edit mode
            document.getElementById('editMealMode').value = 'edit';
            document.getElementById('editMealModalTitle').textContent = `Edit Meals - ${dateDisplay}`;
            document.getElementById('editMealSubmitBtn').textContent = 'Save Changes';
            document.getElementById('editMealDateGroup').style.display = 'none';

            document.getElementById('editMealBreakfast').value = meals.breakfast || '';
            document.getElementById('editMealLunch').value = meals.lunch || '';
            document.getElementById('editMealDinner').value = meals.dinner || '';
            document.getElementById('editMealSnacks').value = meals.snacks || '';
            document.getElementById('editMealDate').value = dateStr;

            document.getElementById('editMealModal').classList.add('active');
        }

        function closeEditMealModal() {
            document.getElementById('editMealModal').classList.remove('active');
            document.getElementById('editMealDateGroup').style.display = 'none';
        }

        function saveEditedMeal() {
            const mode = document.getElementById('editMealMode').value;
            let dateStr;

            if (mode === 'add') {
                dateStr = document.getElementById('editMealDatePicker').value;
                if (!dateStr) {
                    showNotification('Please select a date', 'error');
                    return;
                }
            } else {
                dateStr = document.getElementById('editMealDate').value;
            }

            const log = getLogByDate(dateStr);

            log.meals = {
                breakfast: document.getElementById('editMealBreakfast').value.trim(),
                lunch: document.getElementById('editMealLunch').value.trim(),
                dinner: document.getElementById('editMealDinner').value.trim(),
                snacks: document.getElementById('editMealSnacks').value.trim()
            };

            saveData();
            closeEditMealModal();
            renderMealLogHistory();
            showNotification(mode === 'add' ? 'Meals logged!' : 'Meals updated!', 'success');

            // Also update the homepage meal tracker if it's for yesterday
            const yesterday = getYesterday();
            if (dateStr === yesterday) {
                renderMealTracker();
            }

            // Auto-sync to gist if configured
            const settings = getGitHubSettings();
            if (settings.token) {
                syncMealsToGist().then(result => {
                    if (result.success) {
                        showNotification('Synced to cloud', 'success');
                    }
                });
            }
        }

        function renderTaskItem(task) {
            const categoryIcon = task.category === 'work' ? '&#128188;' : '&#127968;';
            let dueDateDisplay = '';
            if (task.dueDate) {
                const today = new Date(getToday() + 'T00:00:00');
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                const diffDays = Math.round((dueDate - today) / (1000 * 60 * 60 * 24));
                let dueDateText = '';
                let dueDateColor = 'var(--text-muted)';
                if (diffDays < 0) {
                    dueDateText = 'Overdue';
                    dueDateColor = 'var(--coral)';
                } else if (diffDays === 0) {
                    dueDateText = 'Today';
                    dueDateColor = 'var(--amber)';
                } else if (diffDays === 1) {
                    dueDateText = 'Tomorrow';
                } else if (diffDays <= 7) {
                    dueDateText = dueDate.toLocaleDateString('en-US', { weekday: 'short' });
                } else {
                    dueDateText = dueDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                dueDateDisplay = `<span style="font-size: 0.75rem; color: ${dueDateColor}; margin-left: 0.5rem;">${dueDateText}</span>`;
            }
            return `
                <div class="task-item ${task.completed ? 'completed' : ''}">
                    <div class="task-checkbox ${task.completed ? 'checked' : ''}" onclick="toggleTask('${task.id}')">
                        ${task.completed ? '&#10003;' : ''}
                    </div>
                    <span class="task-text">${task.title}${dueDateDisplay}</span>
                    <span style="font-size: 0.8rem; color: var(--text-muted);">${categoryIcon}</span>
                    <button class="task-delete" onclick="editTask('${task.id}')" title="Edit">&#9998;</button>
                    <button class="task-delete" onclick="deleteTask('${task.id}')" title="Delete">&#128465;</button>
                </div>
            `;
        }

        let editingTaskId = null;

        function editTask(id) {
            const task = appData.tasks.find(t => t.id === id);
            if (!task) return;

            editingTaskId = id;
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('taskSubmitBtn').textContent = 'Save';
            document.getElementById('taskTitle').value = task.title;
            document.getElementById('taskCategory').value = task.category || 'personal';
            document.getElementById('taskTerm').value = task.term || 'short';
            document.getElementById('taskDueDate').value = task.dueDate || '';

            document.getElementById('taskModal').classList.add('active');
        }

        // ==================== CONSUMPTION ====================
        function openConsumptionModal() {
            editingConsumptionId = null;
            document.getElementById('consumptionModalTitle').textContent = 'Log Something You Consumed';
            document.getElementById('consumptionSubmitBtn').textContent = 'Add';
            document.getElementById('consumptionModal').classList.add('active');
            document.getElementById('consumptionScore').value = 70;
            document.getElementById('consumptionScoreDisplay').textContent = '70';
            document.getElementById('consumptionDate').value = new Date().toISOString().split('T')[0];
            toggleConsumptionUrlField();
        }
        function openConsumptionModalWithContext() {
            editingConsumptionId = null;
            document.getElementById('consumptionModalTitle').textContent = 'Log Something You Consumed';
            document.getElementById('consumptionSubmitBtn').textContent = 'Add';
            document.getElementById('consumptionType').value = currentConsumptionTab;
            document.getElementById('consumptionModal').classList.add('active');
            document.getElementById('consumptionScore').value = 70;
            document.getElementById('consumptionScoreDisplay').textContent = '70';
            document.getElementById('consumptionDate').value = new Date().toISOString().split('T')[0];
            toggleConsumptionUrlField();
        }
        function closeConsumptionModal() {
            document.getElementById('consumptionModal').classList.remove('active');
            document.getElementById('consumptionTitle').value = '';
            document.getElementById('consumptionNotes').value = '';
            document.getElementById('consumptionUrl').value = '';
            editingConsumptionId = null;
        }

        function updateScoreDisplay() {
            const score = document.getElementById('consumptionScore').value;
            document.getElementById('consumptionScoreDisplay').textContent = score;
        }

        function getScoreColor(score) {
            if (score >= 90) return '#2D5A3D'; // Forest green
            if (score >= 70) return '#3D7A52'; // Light forest
            if (score >= 50) return '#D4A84B'; // Amber
            if (score >= 30) return '#C75D5D'; // Red soft
            return '#8B0000'; // Dark red
        }

        function toggleConsumptionUrlField() {
            const type = document.getElementById('consumptionType').value;
            const shouldShow = type === 'recipe' || type === 'restaurant';
            document.getElementById('consumptionUrlGroup').classList.toggle('is-hidden', !shouldShow);
            if (!shouldShow) {
                document.getElementById('consumptionUrl').value = '';
            }
        }

        function addConsumption() {
            const title = document.getElementById('consumptionTitle').value.trim();
            if (!title) return;

            const score = parseInt(document.getElementById('consumptionScore').value);
            const url = normalizeUrl(document.getElementById('consumptionUrl').value);

            if (editingConsumptionId) {
                // Update existing item
                const item = appData.consumption.find(c => c.id === editingConsumptionId);
                if (item) {
                    item.type = document.getElementById('consumptionType').value;
                    item.title = title;
                    item.score = score;
                    item.notes = document.getElementById('consumptionNotes').value.trim();
                    item.url = url || null;
                    item.date = document.getElementById('consumptionDate').value || item.date;
                }
                editingConsumptionId = null;
            } else {
                // Add new item
                appData.consumption.push({
                    id: generateId(),
                    type: document.getElementById('consumptionType').value,
                    title,
                    score: score,
                    notes: document.getElementById('consumptionNotes').value.trim(),
                    url: url || null,
                    date: new Date().toISOString()
                });
            }

            saveData();
            closeConsumptionModal();
            renderConsumption();
        }

        function deleteConsumption(id) {
            appData.consumption = appData.consumption.filter(c => c.id !== id);
            saveData();
            renderConsumption();
        }

        function renderConsumption() {
            // Update tab highlighting
            document.querySelectorAll('.consumption-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === currentConsumptionTab);
            });

            const container = document.getElementById('consumptionList');
            const items = appData.consumption
                .filter(c => c.type === currentConsumptionTab)
                .sort((a, b) => (b.score || 0) - (a.score || 0)); // Sort by score descending

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">&#127916;</div><p>Nothing logged yet</p></div>';
                return;
            }

            const icons = { tvshow: '&#128250;', movie: '&#127910;', book: '&#128218;', recipe: '&#127869;', restaurant: '&#127860;' };

            container.innerHTML = items.map(item => {
                const score = item.score || 50;
                const scoreColor = getScoreColor(score);
                const itemUrl = normalizeUrl(item.url);
                const titleHtml = itemUrl ? `<a href="${itemUrl}" target="_blank" style="color: inherit; text-decoration: none;">${item.title} &#128279;</a>` : item.title;
                return `
                    <div class="consumption-item">
                        <div class="consumption-poster">${icons[item.type] || '&#127916;'}</div>
                        <div class="consumption-info">
                            <div class="consumption-title">${titleHtml}</div>
                            <div class="consumption-meta">${new Date(item.date).toLocaleDateString()}</div>
                            ${item.notes ? `<div class="consumption-notes">"${item.notes}"</div>` : ''}
                        </div>
                        <span style="font-size: 1.5rem; font-weight: 700; color: ${scoreColor}; min-width: 50px; text-align: center;">${score}</span>
                        <button class="task-delete" onclick="editConsumption('${item.id}')" style="opacity: 1;" title="Edit">&#9998;</button>
                        <button class="task-delete" onclick="deleteConsumption('${item.id}')" style="opacity: 1;" title="Delete">&#128465;</button>
                    </div>
                `;
            }).join('');
        }

        let editingConsumptionId = null;

        function editConsumption(id) {
            const item = appData.consumption.find(c => c.id === id);
            if (!item) return;

            editingConsumptionId = id;
            document.getElementById('consumptionModalTitle').textContent = 'Edit Consumed Item';
            document.getElementById('consumptionSubmitBtn').textContent = 'Save';
            document.getElementById('consumptionType').value = item.type;
            document.getElementById('consumptionTitle').value = item.title;
            document.getElementById('consumptionDate').value = item.date ? item.date.split('T')[0] : '';
            document.getElementById('consumptionScore').value = item.score || 50;
            document.getElementById('consumptionScoreDisplay').textContent = item.score || 50;
            document.getElementById('consumptionNotes').value = item.notes || '';
            document.getElementById('consumptionUrl').value = item.url || '';
            toggleConsumptionUrlField();

            document.getElementById('consumptionModal').classList.add('active');
        }

        document.querySelectorAll('.consumption-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentConsumptionTab = tab.dataset.tab;
                renderConsumption();
            });
        });

        document.getElementById('consumptionType').addEventListener('change', toggleConsumptionUrlField);

        // ==================== NOTES ====================
        let currentNoteId = null;

        function renderNotes() {
            const container = document.getElementById('notesList');
            if (!container) return;

            const notes = [...(appData.notes || [])].sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));

            if (notes.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">No notes yet. Create one to get started!</div>';
            } else {
                container.innerHTML = notes.map(note => `
                    <div class="note-card ${currentNoteId === note.id ? 'active' : ''}" onclick="loadNote('${note.id}')">
                        <div class="note-card-title">${note.title || 'Untitled'}</div>
                        <div class="note-card-date">${new Date(note.updatedAt).toLocaleDateString()}</div>
                        <div class="note-card-preview">${note.content.substring(0, 60) || 'Empty note'}</div>
                    </div>
                `).join('');
            }

            // Show/hide delete button based on selection
            const deleteBtn = document.getElementById('deleteNoteBtn');
            if (deleteBtn) {
                deleteBtn.style.display = currentNoteId ? 'block' : 'none';
            }
        }

        function newNote() {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('deleteNoteBtn').style.display = 'none';
            renderNotes();
        }

        function loadNote(id) {
            const note = (appData.notes || []).find(n => n.id === id);
            if (note) {
                currentNoteId = id;
                document.getElementById('noteTitle').value = note.title || '';
                document.getElementById('noteContent').value = note.content || '';
                document.getElementById('deleteNoteBtn').style.display = 'block';
                renderNotes();
            }
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();

            if (!title && !content) {
                showNotification('Please add a title or content', 'error');
                return;
            }

            if (!appData.notes) appData.notes = [];

            if (currentNoteId) {
                const note = appData.notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.title = title;
                    note.content = content;
                    note.updatedAt = new Date().toISOString();
                }
            } else {
                const newNote = {
                    id: generateId(),
                    title: title || 'Untitled',
                    content,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                appData.notes.push(newNote);
                currentNoteId = newNote.id;
            }

            saveData();
            renderNotes();
            showNotification('Note saved!', 'success');
        }

        function deleteCurrentNote() {
            if (!currentNoteId) return;

            if (confirm('Delete this note?')) {
                appData.notes = (appData.notes || []).filter(n => n.id !== currentNoteId);
                currentNoteId = null;
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                saveData();
                renderNotes();
                showNotification('Note deleted', 'success');
            }
        }

        // ==================== RESEARCH ====================
        function openNoteModal() { document.getElementById('noteModal').classList.add('active'); }
        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteUrl').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteTags').value = '';
        }

        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const url = normalizeUrl(document.getElementById('noteUrl').value);
            if (!title) return;

            appData.notes.push({
                id: generateId(),
                title,
                url: url || null,
                content,
                category: document.getElementById('noteCategory').value,
                tags: document.getElementById('noteTags').value.split(',').map(t => t.trim()).filter(t => t),
                date: new Date().toISOString()
            });

            saveData();
            closeNoteModal();
            renderResearch();
        }

        function deleteNote(id) {
            appData.notes = appData.notes.filter(n => n.id !== id);
            saveData();
            renderResearch();
        }

        function searchNotes() {
            renderResearch(document.getElementById('researchSearch').value.toLowerCase());
        }

        async function loadResearchFeed() {
            if (researchFeedCache) return researchFeedCache;
            try {
                const response = await fetch('research-feed.json', { cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to load feed');
                const data = await response.json();
                researchFeedCache = data;
                return data;
            } catch (error) {
                researchFeedCache = { updated: null, items: [], error: true };
                return researchFeedCache;
            }
        }

        let potsResearchCache = null;
        let currentPotsCategory = 0;

        async function loadPotsResearch() {
            if (potsResearchCache) return potsResearchCache;
            try {
                const response = await fetch('pots-research.json', { cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to load POTS research');
                const data = await response.json();
                potsResearchCache = data;
                return data;
            } catch (error) {
                potsResearchCache = { updated: null, categories: [], error: true };
                return potsResearchCache;
            }
        }

        function renderPotsResearch() {
            const tabsContainer = document.getElementById('potsCategoryTabs');
            const contentContainer = document.getElementById('potsResearchContent');
            if (!tabsContainer || !contentContainer) return;

            loadPotsResearch().then(data => {
                if (!data || !data.categories || data.categories.length === 0) {
                    contentContainer.innerHTML = '<div class="empty-state"><p>No POTS research available</p></div>';
                    return;
                }

                // Render category tabs
                tabsContainer.innerHTML = data.categories.map((cat, idx) => `
                    <button class="pots-category-tab ${idx === currentPotsCategory ? 'active' : ''}"
                            onclick="selectPotsCategory(${idx})">
                        ${cat.name}
                    </button>
                `).join('');

                // Render current category content
                const category = data.categories[currentPotsCategory];
                contentContainer.innerHTML = `
                    <div class="pots-category-description">${category.description}</div>
                    ${category.items.map((item, idx) => `
                        <div class="pots-research-item" onclick="togglePotsItem(this)">
                            <div class="pots-research-header">
                                <div>
                                    <div class="pots-research-title">${item.title}</div>
                                    <div class="pots-research-source">${item.source} ${item.year ? 'â€¢ ' + item.year : ''}</div>
                                </div>
                                <span class="pots-research-expand">&#9662;</span>
                            </div>
                            <div class="pots-research-description">${item.description}</div>
                            <div class="pots-research-details">
                                ${item.keyPoints && item.keyPoints.length ? `
                                    <ul class="pots-key-points">
                                        ${item.keyPoints.map(point => `<li>${point}</li>`).join('')}
                                    </ul>
                                ` : ''}
                                ${item.url ? `<a href="${item.url}" target="_blank" class="pots-research-link">Learn more &#8594;</a>` : ''}
                            </div>
                        </div>
                    `).join('')}
                `;
            });
        }

        function selectPotsCategory(idx) {
            currentPotsCategory = idx;
            renderPotsResearch();
        }

        function togglePotsItem(element) {
            element.classList.toggle('expanded');
        }

        function formatFeedDate(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function renderResearchFeed() {
            const container = document.getElementById('researchFeedList');
            const updatedLabel = document.getElementById('researchFeedUpdated');
            if (!container) return;

            loadResearchFeed().then(feed => {
                if (!feed || feed.items.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No research updates yet</p></div>';
                } else {
                    const newItems = feed.items.filter(item => item.isNew);
                    const olderItems = feed.items.filter(item => !item.isNew);

                    let html = '';

                    // New This Week section
                    if (newItems.length > 0) {
                        html += `<div style="margin-bottom: 1rem;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: var(--forest); margin-bottom: 0.5rem;">&#10024; New This Week (${newItems.length})</div>
                            ${newItems.slice(0, 5).map(item => `
                                <div class="research-feed-item" style="background: var(--forest-light); border-left: 3px solid var(--forest);">
                                    <div class="research-feed-title">
                                        <a href="${item.url}" target="_blank">${item.title}</a>
                                    </div>
                                    <div class="research-feed-meta">${item.source || 'Source'} â€¢ ${formatFeedDate(item.published)}</div>
                                </div>
                            `).join('')}
                        </div>`;
                    }

                    // Previous items
                    if (olderItems.length > 0) {
                        const showCount = newItems.length > 0 ? 3 : 8;
                        html += olderItems.slice(0, showCount).map(item => `
                            <div class="research-feed-item">
                                <div class="research-feed-title">
                                    <a href="${item.url}" target="_blank">${item.title}</a>
                                </div>
                                <div class="research-feed-meta">${item.source || 'Source'} â€¢ ${formatFeedDate(item.published)}</div>
                            </div>
                        `).join('');
                    }

                    container.innerHTML = html;
                }
                if (updatedLabel) {
                    updatedLabel.textContent = feed.updated ? `Updated ${formatFeedDate(feed.updated)}` : 'Updated time unknown';
                }
            });
        }

        function renderResearch(search = '') {
            renderPotsResearch();
            const container = document.getElementById('notesList');
            let notes = appData.notes;

            if (search) {
                notes = notes.filter(n =>
                    n.title.toLowerCase().includes(search) ||
                    n.content.toLowerCase().includes(search) ||
                    n.tags.some(t => t.toLowerCase().includes(search))
                );
            }

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128218;</div><p>No notes yet</p></div>';
                return;
            }

            const categoryIcons = { health: '&#128154;', learning: '&#128218;', work: '&#128188;', ideas: '&#128161;' };

            container.innerHTML = notes.map(note => {
                const noteUrl = normalizeUrl(note.url);
                return `
                <div class="note-card">
                    <div class="note-title">
                        <span>${categoryIcons[note.category]} ${noteUrl ? `<a href="${noteUrl}" target="_blank" style="color: var(--forest);">${note.title} &#128279;</a>` : note.title}</span>
                        <button class="task-delete" onclick="deleteNote('${note.id}')" style="opacity: 1;">&#128465;</button>
                    </div>
                    ${noteUrl ? `<div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; word-break: break-all;">${noteUrl}</div>` : ''}
                    <div class="note-content">${note.content ? (note.content.substring(0, 200) + (note.content.length > 200 ? '...' : '')) : ''}</div>
                    ${note.tags && note.tags.length ? `<div>${note.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div>` : ''}
                </div>
            `;
            }).join('');
        }

        // ==================== HEALTH ====================
        function renderHealth() {
            // Render Oura data
            renderOuraData();
        }

        // ==================== WATCHLIST ====================

        function openWatchlistModal() {
            document.getElementById('watchlistModalTitle').textContent = 'Add to Watchlist';
            document.getElementById('watchlistSubmitBtn').textContent = 'Add';
            document.getElementById('watchlistTitle').value = '';
            document.getElementById('watchlistUrl').value = '';
            document.getElementById('watchlistNotes').value = '';
            document.getElementById('watchlistModal').classList.add('active');
        }

        function openWatchlistModalWithContext() {
            document.getElementById('watchlistType').value = currentWatchlistTab;
            openWatchlistModal();
        }

        function closeWatchlistModal() {
            document.getElementById('watchlistModal').classList.remove('active');
            document.getElementById('watchlistTitle').value = '';
            document.getElementById('watchlistUrl').value = '';
            document.getElementById('watchlistNotes').value = '';
        }

        function addWatchlistItem() {
            const title = document.getElementById('watchlistTitle').value.trim();
            if (!title) return;

            if (!appData.watchlist) appData.watchlist = [];

            appData.watchlist.push({
                id: generateId(),
                type: document.getElementById('watchlistType').value,
                title: title,
                notes: document.getElementById('watchlistNotes').value.trim(),
                url: normalizeUrl(document.getElementById('watchlistUrl').value),
                dateAdded: new Date().toISOString().split('T')[0],
                source: 'manual'
            });

            saveData();
            closeWatchlistModal();
            renderWatchlist();
        }

        function deleteWatchlistItem(id) {
            appData.watchlist = appData.watchlist.filter(w => w.id !== id);
            saveData();
            renderWatchlist();
        }

        function moveToConsumed(id) {
            const item = appData.watchlist.find(w => w.id === id);
            if (!item) return;

            const typeMap = { movie: 'movie', tvshow: 'tvshow', book: 'book', game: 'movie', article: 'book' };
            document.getElementById('consumptionType').value = typeMap[item.type] || 'movie';
            document.getElementById('consumptionTitle').value = item.title;
            document.getElementById('consumptionNotes').value = item.notes || '';
            document.getElementById('consumptionUrl').value = item.url || '';
            document.getElementById('consumptionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('consumptionScore').value = 70;
            document.getElementById('consumptionScoreDisplay').textContent = '70';
            toggleConsumptionUrlField();
            document.getElementById('consumptionModal').classList.add('active');

            appData.watchlist = appData.watchlist.filter(w => w.id !== id);
            saveData();
            renderWatchlist();
        }

        async function loadGoodreadsFeed() {
            if (goodreadsFeedCache) return goodreadsFeedCache;
            try {
                const response = await fetch('goodreads-feed.json', { cache: 'no-store' });
                if (!response.ok) throw new Error('Failed to load Goodreads feed');
                const data = await response.json();
                goodreadsFeedCache = data;
                return data;
            } catch (error) {
                goodreadsFeedCache = { updated: null, books: [], error: true };
                return goodreadsFeedCache;
            }
        }

        function renderWatchlist() {
            if (!appData.watchlist) appData.watchlist = [];

            document.querySelectorAll('#watchlistTabs .consumption-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.watchlisttab === currentWatchlistTab);
            });

            const container = document.getElementById('watchlistList');
            const manualItems = appData.watchlist
                .filter(w => w.type === currentWatchlistTab)
                .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

            if (currentWatchlistTab === 'book') {
                renderWatchlistBooks(container, manualItems);
            } else {
                renderWatchlistItems(container, manualItems);
            }
        }

        function renderWatchlistItems(container, items) {
            const icons = {
                movie: '&#127910;',
                tvshow: '&#128250;',
                book: '&#128218;',
                game: '&#127918;',
                article: '&#128196;'
            };

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128209;</div><p>Nothing on your list yet</p></div>';
                return;
            }

            container.innerHTML = items.map(item => {
                const itemUrl = normalizeUrl(item.url);
                const titleHtml = itemUrl
                    ? `<a href="${itemUrl}" target="_blank" style="color: inherit; text-decoration: none;">${escapeHtml(item.title)} &#128279;</a>`
                    : escapeHtml(item.title);
                return `
                    <div class="consumption-item">
                        <div class="consumption-poster">${icons[item.type] || '&#128209;'}</div>
                        <div class="consumption-info">
                            <div class="consumption-title">${titleHtml}</div>
                            <div class="consumption-meta">Added ${new Date(item.dateAdded).toLocaleDateString()}</div>
                            ${item.notes ? `<div class="consumption-notes">"${escapeHtml(item.notes)}"</div>` : ''}
                        </div>
                        <div class="watchlist-item-actions">
                            <button class="task-delete" onclick="moveToConsumed('${item.id}')" style="opacity: 1;" title="Mark as consumed">&#9989;</button>
                            <button class="task-delete" onclick="deleteWatchlistItem('${item.id}')" style="opacity: 1;" title="Remove">&#128465;</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function renderWatchlistBooks(container, manualItems) {
            const goodreads = await loadGoodreadsFeed();
            const goodreadsBooks = (goodreads && goodreads.books) ? goodreads.books : [];

            let html = '';

            if (manualItems.length > 0) {
                html += manualItems.map(item => {
                    const itemUrl = normalizeUrl(item.url);
                    const titleHtml = itemUrl
                        ? `<a href="${itemUrl}" target="_blank" style="color: inherit; text-decoration: none;">${escapeHtml(item.title)} &#128279;</a>`
                        : escapeHtml(item.title);
                    return `
                        <div class="consumption-item">
                            <div class="consumption-poster">&#128218;</div>
                            <div class="consumption-info">
                                <div class="consumption-title">${titleHtml}</div>
                                <div class="consumption-meta">Added ${new Date(item.dateAdded).toLocaleDateString()}</div>
                                ${item.notes ? `<div class="consumption-notes">"${escapeHtml(item.notes)}"</div>` : ''}
                            </div>
                            <div class="watchlist-item-actions">
                                <button class="task-delete" onclick="moveToConsumed('${item.id}')" style="opacity: 1;" title="Mark as consumed">&#9989;</button>
                                <button class="task-delete" onclick="deleteWatchlistItem('${item.id}')" style="opacity: 1;" title="Remove">&#128465;</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            if (goodreadsBooks.length > 0) {
                html += `
                    <div style="margin-top: ${manualItems.length > 0 ? '1.5rem' : '0'}; margin-bottom: 0.75rem;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--forest); margin-bottom: 0.25rem;">
                            &#128214; From Goodreads (${goodreadsBooks.length})
                        </div>
                        ${goodreads.updated ? `<div style="font-size: 0.75rem; color: var(--text-muted);">Last synced ${new Date(goodreads.updated).toLocaleDateString()}</div>` : ''}
                    </div>
                `;
                html += goodreadsBooks.map(book => `
                    <div class="consumption-item" style="border-left: 3px solid var(--forest);">
                        <div class="consumption-poster" style="background: transparent; width: 50px; height: 70px; overflow: hidden; font-size: 2rem;">
                            ${book.image_url
                                ? `<img src="${book.image_url}" alt="" style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--radius-sm);">`
                                : '&#128218;'
                            }
                        </div>
                        <div class="consumption-info">
                            <div class="consumption-title">
                                <a href="${book.link}" target="_blank" style="color: inherit; text-decoration: none;">${escapeHtml(book.title)} &#128279;</a>
                            </div>
                            <div class="consumption-meta">${escapeHtml(book.author || '')}${book.average_rating ? ` &bull; ${book.average_rating} avg` : ''}</div>
                        </div>
                        <span class="watchlist-source-badge">Goodreads</span>
                    </div>
                `).join('');
            }

            if (!html) {
                html = '<div class="empty-state"><div class="empty-icon">&#128218;</div><p>No books on your list yet</p></div>';
            }

            container.innerHTML = html;
        }

        // Watchlist tab switching
        document.querySelectorAll('#watchlistTabs .consumption-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentWatchlistTab = tab.dataset.watchlisttab;
                renderWatchlist();
            });
        });

        // ==================== INSIGHTS ====================
        function renderInsights() {
            const insights = [];

            const todayLog = getTodayLog();
            if (todayLog.water >= 8) {
                insights.push({
                    icon: '&#128167;',
                    text: `Great hydration today! You're at <span class="insight-data">${todayLog.water} glasses</span>`
                });
            }

            if (appData.user.streakDays >= 3) {
                insights.push({
                    icon: '&#128293;',
                    text: `You're on a <span class="insight-data">${appData.user.streakDays} day streak</span>! Keep it going!`
                });
            }

            const completedTasks = appData.tasks.filter(t => t.completed).length;
            if (completedTasks > 0) {
                insights.push({
                    icon: '&#9745;',
                    text: `You've completed <span class="insight-data">${completedTasks} tasks</span> total`
                });
            }

            const container = document.getElementById('insightsList');
            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="insight-card">
                        <div class="insight-icon">&#128161;</div>
                        <div class="insight-text">Keep logging data to unlock personalized insights about your patterns!</div>
                    </div>
                `;
            } else {
                container.innerHTML = insights.map(i => `
                    <div class="insight-card">
                        <div class="insight-icon">${i.icon}</div>
                        <div class="insight-text">${i.text}</div>
                    </div>
                `).join('');
            }

            // Overall stats
            const statsContainer = document.getElementById('overallStats');
            const books = appData.consumption.filter(c => c.type === 'book').length;
            const movies = appData.consumption.filter(c => c.type === 'movie').length;
            const tvShows = appData.consumption.filter(c => c.type === 'tv').length;
            const recipes = appData.consumption.filter(c => c.type === 'recipe').length;
            const restaurants = appData.consumption.filter(c => c.type === 'restaurant').length;

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${appData.tasks.filter(t => t.completed).length}</div>
                    <div class="stat-label">Tasks Done</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${(appData.notes || []).length}</div>
                    <div class="stat-label">Notes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${books}</div>
                    <div class="stat-label">Books Read</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${movies}</div>
                    <div class="stat-label">Movies Watched</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${tvShows}</div>
                    <div class="stat-label">TV Shows</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${recipes}</div>
                    <div class="stat-label">Recipes Tried</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${restaurants}</div>
                    <div class="stat-label">Restaurants</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${appData.user.streakDays}</div>
                    <div class="stat-label">Day Streak</div>
                </div>
            `;
        }

        // ==================== WEEKLY PLANNER ====================
        function getISOWeekKey(date = new Date()) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2, '0')}`;
        }

        function getWeekStartDate(date = new Date()) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            return d.toISOString().split('T')[0];
        }

        function getTodayDayKey() {
            const days = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            return days[new Date().getDay()];
        }

        function createEmptyWeekPlan(weekKey, startDate) {
            const dayKeys = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const dayData = {};
            dayKeys.forEach(d => {
                dayData[d] = {
                    meals: {
                        breakfast: { text: '', done: false },
                        lunch: { text: '', done: false },
                        dinner: { text: '', done: false }
                    },
                    workout: { text: '', done: false }
                };
            });
            return {
                weekKey,
                startDate: startDate || getWeekStartDate(),
                createdAt: new Date().toISOString(),
                days: dayData
            };
        }

        function getWeekStartForKey(weekKey) {
            // Parse "2026-W07" -> get the Monday of that ISO week
            const match = weekKey.match(/^(\d{4})-W(\d{2})$/);
            if (!match) return getWeekStartDate();
            const year = parseInt(match[1]);
            const week = parseInt(match[2]);
            // Jan 4 is always in week 1
            const jan4 = new Date(Date.UTC(year, 0, 4));
            const dayOfWeek = jan4.getUTCDay() || 7;
            const monday = new Date(jan4);
            monday.setUTCDate(jan4.getUTCDate() - dayOfWeek + 1 + (week - 1) * 7);
            return monday.toISOString().split('T')[0];
        }

        function getCurrentWeekPlannerData() {
            if (!currentPlannerWeekKey) currentPlannerWeekKey = getISOWeekKey();
            if (!appData.weeklyPlanner) appData.weeklyPlanner = {};
            if (!appData.weeklyPlanner[currentPlannerWeekKey]) {
                const startDate = getWeekStartForKey(currentPlannerWeekKey);
                appData.weeklyPlanner[currentPlannerWeekKey] = createEmptyWeekPlan(currentPlannerWeekKey, startDate);
                saveData();
            }
            return appData.weeklyPlanner[currentPlannerWeekKey];
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // Week navigation
        function plannerPrevWeek() {
            const startDate = new Date(getCurrentWeekPlannerData().startDate + 'T00:00:00');
            startDate.setDate(startDate.getDate() - 7);
            currentPlannerWeekKey = getISOWeekKey(startDate);
            renderPlanner();
        }

        function plannerNextWeek() {
            const startDate = new Date(getCurrentWeekPlannerData().startDate + 'T00:00:00');
            startDate.setDate(startDate.getDate() + 7);
            currentPlannerWeekKey = getISOWeekKey(startDate);
            renderPlanner();
        }

        function plannerCurrentWeek() {
            currentPlannerWeekKey = getISOWeekKey();
            currentPlannerDay = getTodayDayKey();
            renderPlanner();
        }

        // Main render
        function renderPlanner() {
            if (!currentPlannerWeekKey) currentPlannerWeekKey = getISOWeekKey();
            if (!currentPlannerDay) currentPlannerDay = getTodayDayKey();

            const plan = getCurrentWeekPlannerData();
            const start = new Date(plan.startDate + 'T00:00:00');
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            const fmt = { month: 'short', day: 'numeric' };
            document.getElementById('plannerWeekLabel').textContent =
                `${start.toLocaleDateString('en-US', fmt)} â€“ ${end.toLocaleDateString('en-US', fmt)}`;

            document.querySelectorAll('#plannerTabs .consumption-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.plannertab === currentPlannerTab);
            });

            document.getElementById('plannerWeekView').style.display = currentPlannerTab === 'week' ? 'block' : 'none';
            document.getElementById('plannerDayView').style.display = currentPlannerTab === 'day' ? 'block' : 'none';
            document.getElementById('plannerGroceryView').style.display = currentPlannerTab === 'grocery' ? 'block' : 'none';

            if (currentPlannerTab === 'week') renderPlannerWeekView();
            else if (currentPlannerTab === 'day') renderPlannerDayView();
            else if (currentPlannerTab === 'grocery') renderPlannerGroceryList();
        }

        // Tab switching
        document.querySelectorAll('#plannerTabs .consumption-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentPlannerTab = tab.dataset.plannertab;
                renderPlanner();
            });
        });

        // Week Overview
        function renderPlannerWeekView() {
            const plan = getCurrentWeekPlannerData();
            const dayNames = { mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday' };
            const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const today = getTodayDayKey();
            const isCurrentWeek = currentPlannerWeekKey === getISOWeekKey();

            const container = document.getElementById('plannerWeekView');
            container.innerHTML = `
                <div class="planner-week-grid">
                    ${dayOrder.map(dayKey => {
                        const day = plan.days[dayKey];
                        const isToday = isCurrentWeek && dayKey === today;
                        const items = [day.meals.breakfast, day.meals.lunch, day.meals.dinner, day.workout];
                        const totalItems = items.filter(i => i.text).length;
                        const doneItems = items.filter(i => i.done).length;

                        return `
                            <div class="planner-day-card ${isToday ? 'planner-day-today' : ''}" onclick="switchToPlannerDay('${dayKey}')">
                                <div class="planner-day-card-header">
                                    <span class="planner-day-name">${dayNames[dayKey]}</span>
                                    ${totalItems > 0 ? `<span class="planner-day-progress">${doneItems}/${totalItems}</span>` : ''}
                                </div>
                                <div class="planner-day-card-body">
                                    ${renderMiniLine('B', day.meals.breakfast)}
                                    ${renderMiniLine('L', day.meals.lunch)}
                                    ${renderMiniLine('D', day.meals.dinner)}
                                    ${renderMiniWorkout(day.workout)}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderMiniLine(label, meal) {
            if (!meal.text) return `<div class="planner-mini-item empty">${label}: <span class="planner-mini-empty">â€”</span></div>`;
            return `<div class="planner-mini-item ${meal.done ? 'done' : ''}">${label}: ${escapeHtml(meal.text)}</div>`;
        }

        function renderMiniWorkout(workout) {
            if (!workout.text) return `<div class="planner-mini-item empty">&#128170; <span class="planner-mini-empty">Rest day</span></div>`;
            return `<div class="planner-mini-item ${workout.done ? 'done' : ''}">&#128170; ${escapeHtml(workout.text)}</div>`;
        }

        // Day View
        function renderPlannerDayView() {
            const plan = getCurrentWeekPlannerData();
            const dayNames = { mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday', sat: 'Saturday', sun: 'Sunday' };
            const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const day = plan.days[currentPlannerDay];

            const selectorContainer = document.getElementById('plannerDaySelector');
            selectorContainer.innerHTML = dayOrder.map(dk => `
                <button class="planner-day-btn ${dk === currentPlannerDay ? 'active' : ''}" onclick="selectPlannerDay('${dk}')">
                    ${dayNames[dk].substring(0, 3)}
                </button>
            `).join('');

            const contentContainer = document.getElementById('plannerDayContent');
            contentContainer.innerHTML = `
                <h3 style="font-family: 'Merriweather', serif; color: var(--forest); margin-bottom: 1rem;">
                    ${dayNames[currentPlannerDay]}
                </h3>

                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-header">
                        <div class="card-title">&#127869; Meals</div>
                    </div>
                    <div class="card-body">
                        ${renderPlannerMealItem('breakfast', 'Breakfast', day.meals.breakfast)}
                        ${renderPlannerMealItem('lunch', 'Lunch', day.meals.lunch)}
                        ${renderPlannerMealItem('dinner', 'Dinner', day.meals.dinner)}
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#128170; Workout</div>
                    </div>
                    <div class="card-body">
                        ${renderPlannerWorkoutItem(day.workout)}
                    </div>
                </div>
            `;
        }

        function renderPlannerMealItem(mealType, label, meal) {
            return `
                <div class="planner-item ${meal.done ? 'completed' : ''}">
                    <div class="task-checkbox ${meal.done ? 'checked' : ''}"
                         onclick="togglePlannerMeal('${currentPlannerDay}', '${mealType}')">
                        ${meal.done ? '&#10003;' : ''}
                    </div>
                    <div class="planner-item-content">
                        <div class="planner-item-label">${label}</div>
                        <input type="text" class="planner-inline-input"
                               value="${escapeHtml(meal.text)}"
                               placeholder="What are you having?"
                               onchange="updatePlannerMeal('${currentPlannerDay}', '${mealType}', this.value)"
                               onkeydown="if(event.key==='Enter') this.blur()">
                    </div>
                </div>
            `;
        }

        function renderPlannerWorkoutItem(workout) {
            return `
                <div class="planner-item ${workout.done ? 'completed' : ''}">
                    <div class="task-checkbox ${workout.done ? 'checked' : ''}"
                         onclick="togglePlannerWorkout('${currentPlannerDay}')">
                        ${workout.done ? '&#10003;' : ''}
                    </div>
                    <div class="planner-item-content">
                        <input type="text" class="planner-inline-input"
                               value="${escapeHtml(workout.text)}"
                               placeholder="What's the workout? (leave blank for rest day)"
                               onchange="updatePlannerWorkout('${currentPlannerDay}', this.value)"
                               onkeydown="if(event.key==='Enter') this.blur()">
                    </div>
                </div>
            `;
        }

        // Data mutation functions
        function updatePlannerMeal(dayKey, mealType, value) {
            const plan = getCurrentWeekPlannerData();
            plan.days[dayKey].meals[mealType].text = value.trim();
            saveData();
            if (currentPlannerTab === 'week') renderPlannerWeekView();
        }

        function togglePlannerMeal(dayKey, mealType) {
            const plan = getCurrentWeekPlannerData();
            plan.days[dayKey].meals[mealType].done = !plan.days[dayKey].meals[mealType].done;
            saveData();
            if (currentPlannerTab === 'day') renderPlannerDayView();
            else renderPlannerWeekView();
        }

        function updatePlannerWorkout(dayKey, value) {
            const plan = getCurrentWeekPlannerData();
            plan.days[dayKey].workout.text = value.trim();
            saveData();
            if (currentPlannerTab === 'week') renderPlannerWeekView();
        }

        function togglePlannerWorkout(dayKey) {
            const plan = getCurrentWeekPlannerData();
            plan.days[dayKey].workout.done = !plan.days[dayKey].workout.done;
            saveData();
            if (currentPlannerTab === 'day') renderPlannerDayView();
            else renderPlannerWeekView();
        }

        function selectPlannerDay(dayKey) {
            currentPlannerDay = dayKey;
            renderPlannerDayView();
        }

        function switchToPlannerDay(dayKey) {
            currentPlannerDay = dayKey;
            currentPlannerTab = 'day';
            renderPlanner();
        }

        // Grocery List
        function renderPlannerGroceryList() {
            const container = document.getElementById('plannerGroceryView');
            if (!appData.groceryList) appData.groceryList = { items: [] };
            const groceries = appData.groceryList;

            const unchecked = groceries.items.filter(i => !i.checked);
            const checked = groceries.items.filter(i => i.checked);

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">&#128722; Grocery List</div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="autoGenerateGroceryList()" style="font-size: 0.8rem; padding: 0.35rem 0.7rem;">Auto-fill from Meals</button>
                            ${checked.length > 0 ? `<button class="btn btn-secondary" onclick="clearCheckedGroceries()" style="font-size: 0.8rem; padding: 0.35rem 0.7rem;">Clear Checked</button>` : ''}
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                            <input type="text" class="input-field" id="groceryItemInput"
                                   placeholder="Add an item..."
                                   onkeydown="if(event.key==='Enter') addGroceryItem()"
                                   style="flex: 1;">
                            <select class="input-field" id="groceryCategorySelect" style="width: auto; min-width: 120px;">
                                <option value="Produce">Produce</option>
                                <option value="Proteins">Proteins</option>
                                <option value="Dairy">Dairy</option>
                                <option value="Grains">Grains</option>
                                <option value="Pantry">Pantry</option>
                                <option value="Other">Other</option>
                            </select>
                            <button class="btn btn-primary" onclick="addGroceryItem()" style="padding: 0.35rem 0.7rem;">Add</button>
                        </div>

                        ${renderGroceryItemsByCategory(unchecked)}

                        ${checked.length > 0 ? `
                            <div style="margin-top: 1rem; border-top: 1px solid var(--border); padding-top: 0.75rem;">
                                <div style="cursor: pointer; color: var(--text-muted); font-size: 0.85rem; user-select: none;" onclick="toggleCheckedGroceries()">
                                    &#9989; ${checked.length} item${checked.length > 1 ? 's' : ''} checked off
                                    <span id="groceryCheckedToggle">&#9660;</span>
                                </div>
                                <div id="groceryCheckedList" style="display: none; margin-top: 0.5rem;">
                                    ${checked.map(item => renderGroceryItem(item)).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderGroceryItemsByCategory(items) {
            const grouped = {};
            items.forEach(item => {
                const cat = item.category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            const categoryOrder = ['Produce', 'Proteins', 'Dairy', 'Grains', 'Pantry', 'Other'];
            const html = categoryOrder
                .filter(cat => grouped[cat] && grouped[cat].length > 0)
                .map(cat => `
                    <div style="margin-bottom: 0.75rem;">
                        <h4 style="color: var(--forest); font-size: 0.9rem; margin-bottom: 0.4rem;">${cat}</h4>
                        ${grouped[cat].map(item => renderGroceryItem(item)).join('')}
                    </div>
                `).join('');

            return html || '<div class="empty-state"><p>No items yet. Add items above or auto-fill from your meal plan.</p></div>';
        }

        function renderGroceryItem(item) {
            return `
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0; ${item.checked ? 'opacity: 0.5;' : ''}">
                    <div class="task-checkbox ${item.checked ? 'checked' : ''}" onclick="toggleGroceryItem('${item.id}')">
                        ${item.checked ? '&#10003;' : ''}
                    </div>
                    <span style="${item.checked ? 'text-decoration: line-through; color: var(--text-muted);' : ''}">${escapeHtml(item.text)}</span>
                    <button onclick="deleteGroceryItem('${item.id}')" style="margin-left: auto; background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 0.85rem; padding: 0.2rem;" title="Delete">&#128465;</button>
                </div>
            `;
        }

        function addGroceryItem() {
            const input = document.getElementById('groceryItemInput');
            const text = input.value.trim();
            if (!text) return;

            const category = document.getElementById('groceryCategorySelect').value;
            if (!appData.groceryList) appData.groceryList = { items: [] };

            appData.groceryList.items.push({
                id: generateId(),
                text: text,
                checked: false,
                category: category
            });
            saveData();
            input.value = '';
            renderPlannerGroceryList();
        }

        function toggleGroceryItem(id) {
            if (!appData.groceryList) return;
            const item = appData.groceryList.items.find(i => i.id === id);
            if (item) {
                item.checked = !item.checked;
                saveData();
                renderPlannerGroceryList();
            }
        }

        function deleteGroceryItem(id) {
            if (!appData.groceryList) return;
            appData.groceryList.items = appData.groceryList.items.filter(i => i.id !== id);
            saveData();
            renderPlannerGroceryList();
        }

        function clearCheckedGroceries() {
            if (!appData.groceryList) return;
            const checkedCount = appData.groceryList.items.filter(i => i.checked).length;
            if (checkedCount === 0) return;
            if (confirm(`Remove ${checkedCount} checked item${checkedCount > 1 ? 's' : ''}?`)) {
                appData.groceryList.items = appData.groceryList.items.filter(i => !i.checked);
                saveData();
                renderPlannerGroceryList();
                showNotification('Checked items cleared', 'success');
            }
        }

        function toggleCheckedGroceries() {
            const list = document.getElementById('groceryCheckedList');
            const toggle = document.getElementById('groceryCheckedToggle');
            if (!list) return;
            const isHidden = list.style.display === 'none';
            list.style.display = isHidden ? 'block' : 'none';
            toggle.textContent = isHidden ? '&#9650;' : '&#9660;';
        }

        function autoGenerateGroceryList() {
            const plan = getCurrentWeekPlannerData();
            const dayOrder = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];

            const mealTexts = [];
            dayOrder.forEach(dk => {
                const day = plan.days[dk];
                ['breakfast', 'lunch', 'dinner'].forEach(mt => {
                    if (day.meals[mt].text) mealTexts.push(day.meals[mt].text);
                });
            });

            if (mealTexts.length === 0) {
                showNotification('No meals planned yet. Add meals first!', 'error');
                return;
            }

            if (!appData.groceryList) appData.groceryList = { items: [] };

            const existingTexts = new Set(appData.groceryList.items.map(i => i.text.toLowerCase()));
            let added = 0;

            mealTexts.forEach(text => {
                if (!existingTexts.has(text.toLowerCase())) {
                    appData.groceryList.items.push({
                        id: generateId(),
                        text: text,
                        checked: false,
                        category: 'Other'
                    });
                    existingTexts.add(text.toLowerCase());
                    added++;
                }
            });

            saveData();
            renderPlannerGroceryList();
            showNotification(`Added ${added} meal${added !== 1 ? 's' : ''} to grocery list`, 'success');
        }

        function renderNutrition() {
            // Load and render nutrition report
            loadNutritionReport().then(report => {
                renderNutritionReport(report);
            });

            // Render meal log history
            renderMealLogHistory();
        }

        // ==================== YEARLY TRACKER ====================
        function openYearItemModal(type) {
            const titles = { book: 'Add Book', podcast: 'Add Podcast', meal: 'Add Meal Cooked' };
            document.getElementById('yearItemModalTitle').textContent = titles[type] || 'Add Item';
            document.getElementById('yearItemType').value = type;
            document.getElementById('yearItemModal').classList.add('active');
        }

        function closeYearItemModal() {
            document.getElementById('yearItemModal').classList.remove('active');
            document.getElementById('yearItemTitle').value = '';
            document.getElementById('yearItemNotes').value = '';
        }

        function addYearItem() {
            const type = document.getElementById('yearItemType').value;
            const title = document.getElementById('yearItemTitle').value.trim();
            if (!title) return;

            if (!appData.yearlyItems) {
                appData.yearlyItems = { books: [], podcasts: [], meals: [], workouts: [] };
            }

            const item = {
                id: generateId(),
                title,
                notes: document.getElementById('yearItemNotes').value.trim(),
                date: new Date().toISOString()
            };

            const typeMap = { book: 'books', podcast: 'podcasts', meal: 'meals' };
            const category = typeMap[type];
            if (category) {
                appData.yearlyItems[category].push(item);
            }

            saveData();
            closeYearItemModal();
            renderYearlyTracker();
        }

        function renderYearlyTracker() {
            const yearStart = '2026-01-01';

            // Count consumption items by type from the Consumed section
            const yearBooks = appData.consumption.filter(c => c.type === 'book' && c.date >= yearStart).length;
            const yearMovies = appData.consumption.filter(c => c.type === 'movie' && c.date >= yearStart).length;
            const yearTVShows = appData.consumption.filter(c => c.type === 'tvshow' && c.date >= yearStart).length;
            const yearRecipes = appData.consumption.filter(c => c.type === 'recipe' && c.date >= yearStart).length;
            const yearRestaurants = appData.consumption.filter(c => c.type === 'restaurant' && c.date >= yearStart).length;

            // Update consumption stats
            document.getElementById('yearBooks').textContent = yearBooks;
            document.getElementById('yearMovies').textContent = yearMovies;
            document.getElementById('yearTVShows').textContent = yearTVShows;
            document.getElementById('yearRecipes').textContent = yearRecipes;
            document.getElementById('yearRestaurants').textContent = yearRestaurants;

            // Render consumption lists from the Consumed section
            renderYearConsumptionList('book', 'yearBooksList', 'books');
            renderYearConsumptionList('movie', 'yearMoviesList', 'movies');
            renderYearConsumptionList('tvshow', 'yearTVShowsList', 'TV shows');
            renderYearConsumptionList('restaurant', 'yearRestaurantsList', 'restaurants');
            renderYearConsumptionList('recipe', 'yearRecipesList', 'recipes');
        }

        function renderYearConsumptionList(type, containerId, label) {
            const container = document.getElementById(containerId);
            const yearStart = '2026-01-01';
            const items = appData.consumption
                .filter(c => c.type === type && c.date >= yearStart)
                .sort((a, b) => (b.score || 0) - (a.score || 0));

            if (items.length === 0) {
                container.innerHTML = `<div class="empty-state"><p>No ${label} logged yet</p></div>`;
                return;
            }

            container.innerHTML = items.map(item => {
                const score = item.score || 50;
                const scoreColor = getScoreColor(score);
                const itemUrl = normalizeUrl(item.url);
                const titleHtml = itemUrl ? `<a href="${itemUrl}" target="_blank" style="color: inherit; text-decoration: none;">${item.title} &#128279;</a>` : item.title;
                return `
                    <div class="year-item">
                        <div>
                            <span class="year-item-title">${titleHtml}</span>
                            ${item.notes ? `<div style="font-size: 0.85rem; color: var(--text-secondary);">${item.notes}</div>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-weight: 700; color: ${scoreColor};">${score}</span>
                            <span class="year-item-date">${new Date(item.date).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== GITHUB GIST SYNC ====================
        function getGitHubSettings() {
            return {
                token: localStorage.getItem('deanOS_githubToken') || '',
                gistId: localStorage.getItem('deanOS_gistId') || ''
            };
        }

        function saveGitHubSettings() {
            const token = document.getElementById('githubToken').value.trim();
            const gistId = document.getElementById('gistId').value.trim();

            if (token) {
                localStorage.setItem('deanOS_githubToken', token);
            }
            if (gistId) {
                localStorage.setItem('deanOS_gistId', gistId);
            }

            showNotification('GitHub settings saved!', 'success');
            updateSyncStatus();
        }

        function renderSettings() {
            const settings = getGitHubSettings();
            const tokenInput = document.getElementById('githubToken');
            const gistInput = document.getElementById('gistId');

            if (tokenInput && settings.token) {
                tokenInput.value = settings.token;
            }
            if (gistInput && settings.gistId) {
                gistInput.value = settings.gistId;
            }

            updateSyncStatus();
        }

        // ==================== OURA RING INTEGRATION ====================
        async function loadOuraFromFile() {
            const statusEl = document.getElementById('ouraStatus');

            if (statusEl) statusEl.innerHTML = '<p style="color: var(--text-secondary);">Loading Oura data...</p>';

            try {
                const response = await fetch('oura-data.json', { cache: 'no-store' });

                if (!response.ok) {
                    throw new Error('oura-data.json not found. Run the sync script first.');
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const days = data.days || [];

                if (days.length === 0) {
                    throw new Error('No Oura data in file. Run the sync script.');
                }

                // Store full data in localStorage (no transformation needed)
                localStorage.setItem('deanOS_ouraData', JSON.stringify({
                    updated: data.updated,
                    start_date: data.start_date,
                    end_date: data.end_date,
                    days_returned: data.days_returned,
                    workouts: data.workouts || [],
                    days: days
                }));

                // Also update daily logs with Oura data
                for (const day of days) {
                    const log = getLogByDate(day.date);
                    if (day.sleep_score) log.ouraScore = day.sleep_score;
                    if (day.bedtime_start) {
                        const bedtimeTime = day.bedtime_start.split('T')[1];
                        if (bedtimeTime) log.bedtime = bedtimeTime.substring(0, 5);
                    }
                    if (day.bedtime_end) {
                        const wakeTimeTime = day.bedtime_end.split('T')[1];
                        if (wakeTimeTime) log.waketime = wakeTimeTime.substring(0, 5);
                    }
                }
                saveData();

                if (statusEl) statusEl.innerHTML = `<p style="color: var(--forest);">Loaded ${days.length} days of Oura data!</p>`;
                showNotification(`Loaded ${days.length} days of Oura data!`, 'success');

                // Refresh displays
                renderOuraData();
                renderMorning();

            } catch (error) {
                console.error('Oura load error:', error);
                if (statusEl) statusEl.innerHTML = `<p style="color: var(--red-soft);">Error: ${error.message}</p>`;
                showNotification('Failed to load Oura data', 'error');
            }
        }

        function formatSeconds(seconds) {
            if (!seconds) return '--';
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        }

        function renderOuraData() {
            const container = document.getElementById('ouraDataDisplay');
            if (!container) return;

            const stored = localStorage.getItem('deanOS_ouraData');
            if (!stored) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="color: var(--text-secondary);">No Oura data synced</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Run the sync script in Settings to load your Oura data.</p>
                    </div>
                `;
                return;
            }

            const data = JSON.parse(stored);
            const days = data.days || [];
            const workouts = data.workouts || [];

            if (days.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">No recent Oura data found</p>';
                return;
            }

            // Calculate averages for the period
            const recentDays = days.slice(0, 14);
            const avgSleep = Math.round(recentDays.filter(d => d.sleep_score).reduce((s, d) => s + d.sleep_score, 0) / recentDays.filter(d => d.sleep_score).length) || '--';
            const avgReadiness = Math.round(recentDays.filter(d => d.readiness_score).reduce((s, d) => s + d.readiness_score, 0) / recentDays.filter(d => d.readiness_score).length) || '--';
            const avgHRV = Math.round(recentDays.filter(d => d.average_hrv).reduce((s, d) => s + d.average_hrv, 0) / recentDays.filter(d => d.average_hrv).length) || '--';
            const avgSteps = Math.round(recentDays.filter(d => d.steps).reduce((s, d) => s + d.steps, 0) / recentDays.filter(d => d.steps).length) || '--';

            container.innerHTML = `
                <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem;">
                    Last synced: ${new Date(data.updated).toLocaleString()} | ${data.days_returned || days.length} days loaded
                </div>

                <!-- 14-day Averages -->
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.5rem;">
                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--forest);">${avgSleep}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Avg Sleep</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--blue-soft);">${avgReadiness}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Avg Readiness</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--purple-soft);">${avgHRV}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Avg HRV</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--amber);">${avgSteps.toLocaleString()}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Avg Steps</div>
                    </div>
                </div>

                <!-- Daily Data Table -->
                <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="text-align: left; padding: 0.5rem;">Date</th>
                                <th style="text-align: center; padding: 0.5rem;">Sleep</th>
                                <th style="text-align: center; padding: 0.5rem;">Ready</th>
                                <th style="text-align: center; padding: 0.5rem;">Activity</th>
                                <th style="text-align: center; padding: 0.5rem;">HRV</th>
                                <th style="text-align: center; padding: 0.5rem;">Rest HR</th>
                                <th style="text-align: center; padding: 0.5rem;">Steps</th>
                                <th style="text-align: center; padding: 0.5rem;">Sleep Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${days.slice(0, 14).map(day => {
                                const dateObj = new Date(day.date + 'T00:00:00');
                                const dayName = dateObj.toLocaleDateString('en-US', { weekday: 'short' });
                                const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                const sleepColor = getScoreColor(day.sleep_score || 0);
                                const readinessColor = getScoreColor(day.readiness_score || 0);
                                const activityColor = getScoreColor(day.activity_score || 0);
                                const sleepHours = day.total_sleep_seconds ? (day.total_sleep_seconds / 3600).toFixed(1) : '--';
                                return `
                                    <tr style="border-bottom: 1px solid var(--border);" onclick="showOuraDayDetail('${day.date}')" class="oura-day-row">
                                        <td style="padding: 0.5rem;"><strong>${dayName}</strong> ${dateStr}</td>
                                        <td style="text-align: center; padding: 0.5rem; color: ${sleepColor}; font-weight: 600;">${day.sleep_score || '--'}</td>
                                        <td style="text-align: center; padding: 0.5rem; color: ${readinessColor}; font-weight: 600;">${day.readiness_score || '--'}</td>
                                        <td style="text-align: center; padding: 0.5rem; color: ${activityColor}; font-weight: 600;">${day.activity_score || '--'}</td>
                                        <td style="text-align: center; padding: 0.5rem;">${day.average_hrv || '--'}</td>
                                        <td style="text-align: center; padding: 0.5rem;">${day.lowest_hr || day.resting_hr || '--'}</td>
                                        <td style="text-align: center; padding: 0.5rem;">${day.steps ? day.steps.toLocaleString() : '--'}</td>
                                        <td style="text-align: center; padding: 0.5rem;">${sleepHours}h</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>

                <!-- AI Analysis Section -->
                <div id="ouraAnalysisSection" style="margin-top: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="color: var(--forest); margin: 0;">AI Health Insights</h4>
                        <button onclick="showAnalysisInstructions()" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.3rem 0.6rem;">Update Analysis</button>
                    </div>
                    <div id="ouraAnalysisContent">
                        <div style="padding: 1rem; background: var(--bg-input); border-radius: var(--radius-sm); text-align: center;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">No AI analysis yet</p>
                            <p style="font-size: 0.85rem; color: var(--text-muted);">Run: <code>ANTHROPIC_API_KEY=your_key python3 scripts/analyze_oura.py</code></p>
                        </div>
                    </div>
                </div>

                <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 1rem; text-align: center;">
                    Click any row to see detailed breakdown
                </p>
            `;

            // Load AI analysis
            loadOuraAnalysis();
        }

        function showOuraDayDetail(dateStr) {
            const stored = localStorage.getItem('deanOS_ouraData');
            if (!stored) return;

            const data = JSON.parse(stored);
            const day = data.days.find(d => d.date === dateStr);
            if (!day) return;

            const dateObj = new Date(dateStr + 'T00:00:00');
            const dateDisplay = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

            const sleepHours = day.total_sleep_seconds ? (day.total_sleep_seconds / 3600).toFixed(1) : '--';
            const deepHours = day.deep_sleep_seconds ? (day.deep_sleep_seconds / 3600).toFixed(1) : '--';
            const remHours = day.rem_sleep_seconds ? (day.rem_sleep_seconds / 3600).toFixed(1) : '--';
            const lightHours = day.light_sleep_seconds ? (day.light_sleep_seconds / 3600).toFixed(1) : '--';

            const bedtime = day.bedtime_start ? new Date(day.bedtime_start).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '--';
            const waketime = day.bedtime_end ? new Date(day.bedtime_end).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '--';

            const detail = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" onclick="this.remove()">
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius); max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
                        <h3 style="margin-bottom: 1rem; color: var(--forest);">${dateDisplay}</h3>

                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                            <div style="text-align: center; padding: 0.5rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${getScoreColor(day.sleep_score || 0)};">${day.sleep_score || '--'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Sleep</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${getScoreColor(day.readiness_score || 0)};">${day.readiness_score || '--'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Readiness</div>
                            </div>
                            <div style="text-align: center; padding: 0.5rem; background: var(--bg-input); border-radius: var(--radius-sm);">
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${getScoreColor(day.activity_score || 0)};">${day.activity_score || '--'}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">Activity</div>
                            </div>
                        </div>

                        <h4 style="margin: 1rem 0 0.5rem; color: var(--text-primary);">Sleep Breakdown</h4>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Bedtime</span><span>${bedtime}</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Wake time</span><span>${waketime}</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Total Sleep</span><span>${sleepHours}h</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Deep Sleep</span><span>${deepHours}h</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>REM Sleep</span><span>${remHours}h</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Light Sleep</span><span>${lightHours}h</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Efficiency</span><span>${day.sleep_efficiency || '--'}%</span></div>
                        </div>

                        <h4 style="margin: 1rem 0 0.5rem; color: var(--text-primary);">Heart & Recovery</h4>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>HRV</span><span>${day.average_hrv || '--'} ms</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Resting HR</span><span>${day.lowest_hr || day.resting_hr || '--'} bpm</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Avg HR (sleep)</span><span>${day.average_hr_sleep || '--'} bpm</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Breathing Rate</span><span>${day.average_breath || '--'}/min</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Temp Deviation</span><span>${day.temperature_deviation ? day.temperature_deviation.toFixed(2) + 'Â°' : '--'}</span></div>
                            ${day.spo2_average ? `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>SpO2</span><span>${day.spo2_average}%</span></div>` : ''}
                        </div>

                        <h4 style="margin: 1rem 0 0.5rem; color: var(--text-primary);">Activity</h4>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Steps</span><span>${day.steps ? day.steps.toLocaleString() : '--'}</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Active Calories</span><span>${day.active_calories || '--'}</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Total Calories</span><span>${day.total_calories || '--'}</span></div>
                            <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;"><span>Distance</span><span>${day.distance_meters ? (day.distance_meters / 1000).toFixed(1) + ' km' : '--'}</span></div>
                        </div>

                        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 1rem; padding: 0.75rem; background: var(--forest); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer; font-weight: 600;">Close</button>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', detail);
        }

        async function triggerOuraWorkflow() {
            const settings = getGitHubSettings();
            if (!settings.token) {
                showNotification('Add GitHub token in Settings first', 'error');
                return;
            }

            showNotification('Starting Oura sync...', 'success');

            try {
                const response = await fetch('https://api.github.com/repos/dramadan22/deanos/actions/workflows/oura-sync.yml/dispatches', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${settings.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ref: 'main' })
                });

                if (response.status === 204 || response.ok) {
                    showNotification('Oura sync started! Refresh page in ~2 minutes.', 'success');
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to trigger workflow');
                }
            } catch (error) {
                console.error('Workflow trigger error:', error);
                showNotification('Error: ' + error.message, 'error');
            }
        }

        function showAnalysisInstructions() {
            const settings = getGitHubSettings();
            const hasToken = settings.token ? true : false;

            const modal = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;" onclick="this.remove()">
                    <div style="background: var(--bg-card); padding: 1.5rem; border-radius: var(--radius); max-width: 500px; width: 90%;" onclick="event.stopPropagation()">
                        <h3 style="margin-bottom: 1rem; color: var(--forest);">Update Oura Data & Analysis</h3>

                        ${hasToken ? `
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Click below to sync your latest Oura data and generate a new AI analysis. This runs on GitHub and takes about 2 minutes.
                            </p>
                            <button onclick="triggerOuraWorkflow(); this.parentElement.parentElement.remove();" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                                Sync Oura & Update Analysis
                            </button>
                            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1rem; text-align: center;">
                                â€” or reload from existing file â€”
                            </p>
                        ` : `
                            <p style="color: var(--amber); margin-bottom: 1rem;">
                                Add your GitHub token in Settings to enable one-click sync.
                            </p>
                        `}

                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                            <button onclick="loadOuraFromFile(); loadOuraAnalysis(); this.parentElement.parentElement.parentElement.remove(); showNotification('Data reloaded', 'success');" class="btn btn-secondary" style="flex: 1;">Reload Data</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
        }

        async function loadOuraAnalysis() {
            const container = document.getElementById('ouraAnalysisContent');
            if (!container) return;

            try {
                const response = await fetch('oura-analysis.json', { cache: 'no-store' });

                if (!response.ok) {
                    container.innerHTML = `
                        <div style="padding: 1rem; background: var(--bg-input); border-radius: var(--radius-sm); text-align: center;">
                            <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">No AI analysis yet</p>
                            <p style="font-size: 0.85rem; color: var(--text-muted);">Run: <code>python3 scripts/analyze_oura.py</code></p>
                        </div>
                    `;
                    return;
                }

                const data = await response.json();

                if (data.error || !data.analysis) {
                    container.innerHTML = `
                        <div style="padding: 1rem; background: var(--bg-input); border-radius: var(--radius-sm); text-align: center;">
                            <p style="color: var(--text-secondary);">${data.error || 'Analysis not available'}</p>
                            <p style="font-size: 0.85rem; color: var(--text-muted);">Run: <code>ANTHROPIC_API_KEY=your_key python3 scripts/analyze_oura.py</code></p>
                        </div>
                    `;
                    return;
                }

                const analysis = data.analysis;
                const updatedDate = new Date(data.updated).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });

                container.innerHTML = `
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                        Analysis from ${updatedDate} | ${data.days_analyzed || '--'} days analyzed
                    </div>

                    <!-- Overall Assessment -->
                    <div style="padding: 1rem; background: var(--bg-input); border-radius: var(--radius-sm); margin-bottom: 1rem;">
                        <p style="font-size: 0.95rem; color: var(--text-primary); line-height: 1.5;">${analysis.overall_assessment || 'No assessment available'}</p>
                    </div>

                    <!-- What's Going Well -->
                    <div style="margin-bottom: 1rem;">
                        <h5 style="color: var(--forest); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.1rem;">âœ“</span> What's Going Well
                        </h5>
                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                            ${(analysis.whats_going_well || []).map(item => `<li style="margin-bottom: 0.35rem;">${item}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- Areas to Improve -->
                    <div style="margin-bottom: 1rem;">
                        <h5 style="color: var(--amber); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.1rem;">â†‘</span> Areas to Improve
                        </h5>
                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                            ${(analysis.areas_to_improve || []).map(item => `<li style="margin-bottom: 0.35rem;">${item}</li>`).join('')}
                        </ul>
                    </div>

                    <!-- POTS Insights -->
                    ${analysis.pots_specific_insights ? `
                        <div style="padding: 0.75rem 1rem; background: var(--blue-bg); border-left: 3px solid var(--blue-soft); border-radius: var(--radius-sm); margin-bottom: 1rem;">
                            <div style="font-weight: 600; color: var(--blue-soft); font-size: 0.85rem; margin-bottom: 0.25rem;">POTS-Specific Insight</div>
                            <p style="font-size: 0.9rem; color: var(--text-primary); margin: 0;">${analysis.pots_specific_insights}</p>
                        </div>
                    ` : ''}

                    <!-- Focus for Next Week -->
                    ${analysis.focus_for_next_week ? `
                        <div style="padding: 0.75rem 1rem; background: var(--forest-bg); border-left: 3px solid var(--forest); border-radius: var(--radius-sm);">
                            <div style="font-weight: 600; color: var(--forest); font-size: 0.85rem; margin-bottom: 0.25rem;">Focus This Week</div>
                            <p style="font-size: 0.9rem; color: var(--text-primary); margin: 0;">${analysis.focus_for_next_week}</p>
                        </div>
                    ` : ''}
                `;

            } catch (error) {
                console.error('Error loading Oura analysis:', error);
                container.innerHTML = `
                    <div style="padding: 1rem; background: var(--bg-input); border-radius: var(--radius-sm); text-align: center;">
                        <p style="color: var(--text-secondary);">Error loading analysis</p>
                    </div>
                `;
            }
        }

        function updateSyncStatus() {
            const lastCloudSync = localStorage.getItem('deanOS_lastCloudSync');
            const lastMealSync = localStorage.getItem('deanOS_lastMealSync');
            const container = document.getElementById('lastSyncInfo');
            if (!container) return;

            let html = '';

            if (lastCloudSync) {
                const date = new Date(lastCloudSync);
                html += `<p><strong>Last full sync:</strong> ${date.toLocaleString()}</p>`;
            }

            if (lastMealSync) {
                const date = new Date(lastMealSync);
                html += `<p><strong>Last meal sync:</strong> ${date.toLocaleString()}</p>`;
            }

            if (html) {
                html += `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Use "Sync to Cloud" to backup all data. Use "Restore from Cloud" on new devices.</p>`;
                container.innerHTML = html;
            } else {
                container.innerHTML = `<p style="color: var(--text-secondary);">No sync performed yet</p>`;
            }
        }

        function getWeekMealLogs() {
            const logs = [];
            const today = new Date();

            // Get last 7 days of meal logs
            for (let i = 1; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const log = appData.dailyLogs[dateStr];

                if (log && log.meals) {
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                    logs.push({
                        date: dateStr,
                        day: dayName,
                        meals: log.meals
                    });
                }
            }

            return logs.reverse(); // Oldest first
        }

        async function syncMealsToGist() {
            const settings = getGitHubSettings();
            if (!settings.token) {
                return { success: false, error: 'No GitHub token configured' };
            }

            const mealLogs = getWeekMealLogs();
            const content = JSON.stringify({
                updated: new Date().toISOString(),
                weekOf: new Date().toISOString().split('T')[0],
                meals: mealLogs
            }, null, 2);

            try {
                let gistId = settings.gistId;

                if (!gistId) {
                    // Create new gist
                    const createResponse = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            description: 'DeanOS Meal Logs - Nutrition Analysis',
                            public: false,
                            files: {
                                'meal-logs.json': { content }
                            }
                        })
                    });

                    if (!createResponse.ok) {
                        throw new Error(`Failed to create gist: ${createResponse.status}`);
                    }

                    const gistData = await createResponse.json();
                    gistId = gistData.id;
                    localStorage.setItem('deanOS_gistId', gistId);
                    document.getElementById('gistId').value = gistId;
                } else {
                    // Update existing gist
                    const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            files: {
                                'meal-logs.json': { content }
                            }
                        })
                    });

                    if (!updateResponse.ok) {
                        throw new Error(`Failed to update gist: ${updateResponse.status}`);
                    }
                }

                localStorage.setItem('deanOS_lastMealSync', new Date().toISOString());
                updateSyncStatus();
                return { success: true, gistId };

            } catch (error) {
                console.error('Gist sync error:', error);
                return { success: false, error: error.message };
            }
        }

        async function testGistSync() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerHTML = '<p style="color: var(--blue-soft);">Testing sync...</p>';

            const result = await syncMealsToGist();

            if (result.success) {
                statusEl.innerHTML = `
                    <p style="color: var(--forest);">Sync successful!</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">Gist ID: ${result.gistId}</p>
                `;
            } else {
                statusEl.innerHTML = `<p style="color: var(--red-soft);">Sync failed: ${result.error}</p>`;
            }
        }

        // ==================== FULL CLOUD SYNC ====================
        async function syncAllDataToCloud() {
            const settings = getGitHubSettings();
            const statusEl = document.getElementById('syncStatus');

            if (!settings.token) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Please add your GitHub token first</p>';
                return;
            }

            statusEl.innerHTML = '<p style="color: var(--blue-soft);">Syncing all data to cloud...</p>';

            const dataToSync = {
                version: 1,
                updated: new Date().toISOString(),
                appData: appData
            };

            const content = JSON.stringify(dataToSync, null, 2);

            try {
                let gistId = settings.gistId;

                if (!gistId) {
                    // Create new gist
                    const createResponse = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            description: 'DeanOS Data Backup',
                            public: false,
                            files: {
                                'deanos-data.json': { content },
                                'meal-logs.json': { content: JSON.stringify({ updated: new Date().toISOString(), meals: getWeekMealLogs() }, null, 2) }
                            }
                        })
                    });

                    if (!createResponse.ok) {
                        throw new Error(`Failed to create gist: ${createResponse.status}`);
                    }

                    const gistData = await createResponse.json();
                    gistId = gistData.id;
                    localStorage.setItem('deanOS_gistId', gistId);
                    document.getElementById('gistId').value = gistId;
                } else {
                    // Update existing gist
                    const updateResponse = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${settings.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            files: {
                                'deanos-data.json': { content },
                                'meal-logs.json': { content: JSON.stringify({ updated: new Date().toISOString(), meals: getWeekMealLogs() }, null, 2) }
                            }
                        })
                    });

                    if (!updateResponse.ok) {
                        throw new Error(`Failed to update gist: ${updateResponse.status}`);
                    }
                }

                localStorage.setItem('deanOS_lastCloudSync', new Date().toISOString());
                updateSyncStatus();
                statusEl.innerHTML = `
                    <p style="color: var(--forest);">All data synced to cloud!</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">Gist ID: ${gistId}</p>
                `;
                showNotification('Data synced to cloud!', 'success');

            } catch (error) {
                console.error('Cloud sync error:', error);
                statusEl.innerHTML = `<p style="color: var(--red-soft);">Sync failed: ${error.message}</p>`;
                showNotification('Sync failed', 'error');
            }
        }

        async function restoreFromCloud() {
            const settings = getGitHubSettings();
            const statusEl = document.getElementById('syncStatus');

            if (!settings.token) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Please add your GitHub token first</p>';
                return;
            }

            if (!settings.gistId) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Please enter your Gist ID to restore from</p>';
                return;
            }

            if (!confirm('This will replace all local data with cloud data. Continue?')) {
                return;
            }

            statusEl.innerHTML = '<p style="color: var(--blue-soft);">Restoring from cloud...</p>';

            try {
                const response = await fetch(`https://api.github.com/gists/${settings.gistId}`, {
                    headers: {
                        'Authorization': `token ${settings.token}`,
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch gist: ${response.status}`);
                }

                const gistData = await response.json();
                const dataFile = gistData.files['deanos-data.json'];

                if (!dataFile) {
                    throw new Error('No DeanOS data found in this Gist');
                }

                const cloudData = JSON.parse(dataFile.content);

                if (!cloudData.appData) {
                    throw new Error('Invalid data format');
                }

                // Restore the data
                appData = cloudData.appData;
                saveData();

                localStorage.setItem('deanOS_lastCloudSync', new Date().toISOString());
                updateSyncStatus();

                statusEl.innerHTML = `
                    <p style="color: var(--forest);">Data restored from cloud!</p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">Last updated: ${new Date(cloudData.updated).toLocaleString()}</p>
                `;
                showNotification('Data restored from cloud!', 'success');

                // Refresh all views
                renderMorning();

            } catch (error) {
                console.error('Cloud restore error:', error);
                statusEl.innerHTML = `<p style="color: var(--red-soft);">Restore failed: ${error.message}</p>`;
                showNotification('Restore failed', 'error');
            }
        }

        // ==================== NUTRITION REPORT ====================
        async function loadNutritionReport() {
            try {
                const response = await fetch('nutrition-report.json');
                if (!response.ok) return null;
                return await response.json();
            } catch (e) {
                return null;
            }
        }

        function renderNutritionReport(report) {
            const container = document.getElementById('nutritionReportContent');
            const dateEl = document.getElementById('nutritionReportDate');

            if (!report || !report.analysis) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p style="color: var(--text-secondary);">No nutrition report yet</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">Log your meals daily and connect GitHub sync in Settings to receive weekly insights every Saturday.</p>
                    </div>
                `;
                return;
            }

            if (dateEl && report.weekOf) {
                dateEl.textContent = `Week of ${new Date(report.weekOf).toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}`;
            }

            const analysis = report.analysis;

            let html = '';

            // What you did well
            if (analysis.strengths && analysis.strengths.length > 0) {
                html += `
                    <div style="margin-bottom: 1.25rem;">
                        <h4 style="color: var(--forest); margin-bottom: 0.5rem; font-size: 1rem;">What You Did Well</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-primary);">
                            ${analysis.strengths.map(s => `<li style="margin-bottom: 0.3rem;">${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Areas to improve
            if (analysis.gaps && analysis.gaps.length > 0) {
                html += `
                    <div style="margin-bottom: 1.25rem;">
                        <h4 style="color: var(--amber); margin-bottom: 0.5rem; font-size: 1rem;">Nutrient Gaps to Address</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-primary);">
                            ${analysis.gaps.map(g => `<li style="margin-bottom: 0.3rem;">${g}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Meal prep suggestions
            if (analysis.suggestions && analysis.suggestions.length > 0) {
                html += `
                    <div>
                        <h4 style="color: var(--blue-soft); margin-bottom: 0.5rem; font-size: 1rem;">Meal Prep Suggestions</h4>
                        <ul style="margin: 0; padding-left: 1.25rem; color: var(--text-primary);">
                            ${analysis.suggestions.map(s => `<li style="margin-bottom: 0.3rem;">${s}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            container.innerHTML = html || '<p style="color: var(--text-secondary);">Report data incomplete</p>';
        }

        // ==================== INIT ====================
        function init() {
            renderMorning();

            // Set default tier selection
            selectTier('B');
        }

        init();

        // ==================== PASSWORD PROTECTION ====================
        const CORRECT_PASSWORD_HASH = '5e884898da28047d9166e1c5f9eabc9e5f2e3c4d5a6b7c8d9e0f1a2b3c4d5e6f'; // Change this

        function hashPassword(password) {
            // Simple hash for demo - in production use a proper hashing library
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const storedHash = localStorage.getItem('deanOS_passwordHash');

            // First time setup - if no password set, any entry sets it
            if (!storedHash) {
                if (input.length >= 4) {
                    localStorage.setItem('deanOS_passwordHash', hashPassword(input));
                    localStorage.setItem('deanOS_authenticated', 'true');
                    showApp();
                } else {
                    document.getElementById('passwordError').textContent = 'Password must be at least 4 characters';
                    document.getElementById('passwordError').style.display = 'block';
                }
                return;
            }

            // Check password
            if (hashPassword(input) === storedHash) {
                localStorage.setItem('deanOS_authenticated', 'true');
                showApp();
            } else {
                document.getElementById('passwordError').textContent = 'Incorrect password';
                document.getElementById('passwordError').style.display = 'block';
                document.getElementById('passwordInput').value = '';
            }
        }

        function showApp() {
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function logout() {
            localStorage.removeItem('deanOS_authenticated');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('lockScreen').style.display = 'flex';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordError').style.display = 'none';
        }

        function changePassword() {
            const newPwd = document.getElementById('newPassword').value;
            const confirmPwd = document.getElementById('confirmPassword').value;
            const statusEl = document.getElementById('passwordChangeStatus');

            if (newPwd.length < 4) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Password must be at least 4 characters</p>';
                return;
            }

            if (newPwd !== confirmPwd) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Passwords do not match</p>';
                return;
            }

            localStorage.setItem('deanOS_passwordHash', hashPassword(newPwd));
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            statusEl.innerHTML = '<p style="color: var(--forest);">Password updated successfully!</p>';
            showNotification('Password changed!', 'success');
        }

        function exportData() {
            const data = {
                appData: JSON.parse(localStorage.getItem('deanOS_data') || '{}'),
                ouraData: JSON.parse(localStorage.getItem('deanOS_ouraData') || '{}'),
                exportDate: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `deanos-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Data exported!', 'success');
        }

        // Check auth on load
        (function checkAuth() {
            if (localStorage.getItem('deanOS_authenticated') === 'true') {
                showApp();
            }
        })();

        // ==================== SYNC STATUS UI ====================
        function showSyncModal() {
            const modal = document.getElementById('syncModal');
            modal.classList.add('active');
            updateSyncModalStatus();
        }

        function closeSyncModal() {
            document.getElementById('syncModal').classList.remove('active');
        }

        // Close sync modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('syncModal');
            const btn = document.getElementById('syncStatusBtn');
            if (modal.classList.contains('active') &&
                !modal.contains(e.target) &&
                !btn.contains(e.target)) {
                closeSyncModal();
            }
        });

        function updateSyncModalStatus() {
            const statusEl = document.getElementById('syncModalStatus');
            const iconEl = document.getElementById('syncIcon');
            const settings = getGitHubSettings();
            const lastSync = localStorage.getItem('deanOS_lastCloudSync');

            if (!settings.token || !settings.gistId) {
                statusEl.innerHTML = `
                    <p style="color: var(--amber);">&#9888; Not configured</p>
                    <p style="margin-top: 0.5rem;">Set up GitHub token in Settings to enable sync.</p>
                `;
                iconEl.className = 'sync-icon warning';
                return;
            }

            if (lastSync) {
                const date = new Date(lastSync);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);

                let timeAgo;
                if (diffMins < 1) timeAgo = 'just now';
                else if (diffMins < 60) timeAgo = `${diffMins}m ago`;
                else if (diffHours < 24) timeAgo = `${diffHours}h ago`;
                else timeAgo = date.toLocaleDateString();

                statusEl.innerHTML = `
                    <p><strong>Last sync:</strong> ${timeAgo}</p>
                    <p style="margin-top: 0.25rem; font-size: 0.8rem;">${date.toLocaleString()}</p>
                `;

                // Set icon color based on how recent
                if (diffMins < 5) {
                    iconEl.className = 'sync-icon synced';
                } else if (diffHours < 1) {
                    iconEl.className = 'sync-icon synced';
                } else {
                    iconEl.className = 'sync-icon warning';
                }
            } else {
                statusEl.innerHTML = `
                    <p style="color: var(--amber);">&#9888; Never synced</p>
                    <p style="margin-top: 0.5rem;">Tap "Sync Up" to backup your data.</p>
                `;
                iconEl.className = 'sync-icon warning';
            }
        }

        async function quickSync() {
            const iconEl = document.getElementById('syncIcon');
            const statusEl = document.getElementById('syncModalStatus');
            const settings = getGitHubSettings();

            if (!settings.token) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Set up GitHub token in Settings first</p>';
                return;
            }

            iconEl.className = 'sync-icon syncing';
            statusEl.innerHTML = '<p>Syncing to cloud...</p>';

            try {
                await syncAllDataToCloud();
                updateSyncModalStatus();
                showNotification('Synced!', 'success');
            } catch (err) {
                statusEl.innerHTML = `<p style="color: var(--red-soft);">Sync failed: ${err.message}</p>`;
                iconEl.className = 'sync-icon error';
            }
        }

        async function quickRestore() {
            const iconEl = document.getElementById('syncIcon');
            const statusEl = document.getElementById('syncModalStatus');
            const settings = getGitHubSettings();

            if (!settings.token || !settings.gistId) {
                statusEl.innerHTML = '<p style="color: var(--red-soft);">Set up GitHub token and Gist ID in Settings first</p>';
                return;
            }

            iconEl.className = 'sync-icon syncing';
            statusEl.innerHTML = '<p>Pulling from cloud...</p>';

            try {
                await restoreFromCloud();
                updateSyncModalStatus();
                closeSyncModal();
            } catch (err) {
                statusEl.innerHTML = `<p style="color: var(--red-soft);">Restore failed: ${err.message}</p>`;
                iconEl.className = 'sync-icon error';
            }
        }

        // Update sync icon on page load
        setTimeout(updateSyncModalStatus, 500);

        // ==================== MOBILE MENU ====================
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const overlay = document.getElementById('mobileOverlay');

            const isOpen = sidebar.classList.contains('mobile-open');

            if (isOpen) {
                sidebar.classList.remove('mobile-open');
                menuBtn.classList.remove('active');
                overlay.classList.remove('active');
                document.body.classList.remove('menu-open');
            } else {
                sidebar.classList.add('mobile-open');
                menuBtn.classList.add('active');
                overlay.classList.add('active');
                document.body.classList.add('menu-open');
            }
        }

        function closeMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            const overlay = document.getElementById('mobileOverlay');
            sidebar.classList.remove('mobile-open');
            menuBtn.classList.remove('active');
            overlay.classList.remove('active');
            document.body.classList.remove('menu-open');
        }

        // Close mobile menu when clicking a nav item
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    closeMobileMenu();
                }
            });
        });
    </script>
    </div><!-- End mainApp -->
</body>
</html>
